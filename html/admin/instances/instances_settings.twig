{% extends "assets/template.twig" %}
{% block htmlIncludes %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.css" integrity="sha512-pDpLmYKym2pnF0DNYDKxRnOk1wkM9fISpSOjt8kWFKQeDmBTjSnBZhTd41tXwh8+bRMoSaFsRnznZUiH9i3pxA==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.js" integrity="sha512-+cXPhsJzyjNGFm5zE+KPEX4Vr/1AbqCUuzAS8Cy5AfLEWm9+UI9OySleqLiSQOQ5Oa2UrzaeAOijhvV/M4apyQ==" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js" integrity="sha512-1aNp9qKP+hKU/VJwCtYqJP9tdZWbMDN5pEEXXoXT0pTAxZq1HHZhNBR/dtTNSrHO4U1FsFGGILbqG1O9nl8Mdg==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css" integrity="sha512-KuSX+43gVS5MEIJD2ewtrFPOHqC1PJnL8o2f5ciggPC0JUZ8XV0QXlfArO1mSzKkVFdRjsBDfrTU96C5SuRfqQ==" crossorigin="anonymous" />

    <!--Sortable-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>

    <script src="{{ CONFIG.ASSETCDNURL }}/js/invert.min.js"></script>
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12 col-md-8">
        <div class="card ">
            <form id="basicSettings">
                <div class="card-header">
                    <h3 class="card-title">Basics</h3>
                </div>
                <div class="card-body">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" required class="form-control" value="{{ USERDATA.instance.instances_name }}" name="instances_name" placeholder="Your Busineses Name">
                        </div>
                        <div class="form-group">
                            <label>Street Address</label>
                            <textarea required class="form-control" rows="6" name="instances_address">{{ USERDATA.instance.instances_address }}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Public Email address</label>
                            <input type="email" class="form-control" value="{{ USERDATA.instance.instances_email }}" name="instances_email">
                        </div>
                        <div class="form-group">
                            <label>Public Phone Number</label>
                            <input type="phone" class="form-control" value="{{ USERDATA.instance.instances_phone }}" name="instances_phone">
                        </div>
                        <div class="form-group">
                            <label>Website</label>
                            <input required type="url" class="form-control" value="{{ USERDATA.instance.instances_website }}" name="instances_website">
                        </div>
                </div>
                <div class="card-footer">
                    {% if 83|instancePermissions %}
                    <button type="submit" class="btn btn-default">Save</button>
                    {% endif %}
                </div>
            </form>
            <script>
                {% if 83|instancePermissions %}
                $(document).ready(function() {
                    $("#basicSettings").on("submit", function(e){
                        e.preventDefault();
                        var formData = $("#basicSettings").serializeArray();
                        ajaxcall("instances/editInstance.php", {formData});
                    });
                });
                {% endif %}
            </script>
        </div>
        <div class="card ">
                <div class="card-header">
                    <h3 class="card-title">Project PDF Footer</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="instances_quoteTerms">Quotation Footer</label>
                        <textarea class="textarea" id="instances_quoteTerms" placeholder="Place some text here" style="width: 100%; height: 200px; font-size: 14px; line-height: 18px; border: 1px solid #dddddd; padding: 10px;">
                            {{ USERDATA.instance.instances_quoteTerms }}
                        </textarea>
                    </div>
                    <div class="form-group">
                        <label for="instance_quoteFooter">Invoice Footer</label>
                        <textarea class="textarea" id="instances_termsAndPayment" placeholder="Place some text here" style="width: 100%; height: 200px; font-size: 14px; line-height: 18px; border: 1px solid #dddddd; padding: 10px;">
                            {{ USERDATA.instance.instances_termsAndPayment }}
                        </textarea>
                    </div>
                </div>
                <div class="card-footer">
                    {% if 83|instancePermissions %}
                    <button id="saveTermsAndPayment" class="btn btn-default">Save</button>
                    {% endif %}
                </div>
            <script>
                $(document).ready(function() {
                    $('#instances_termsAndPayment, #instances_quoteTerms').summernote({
                        toolbar: [
                            ['style', ['style']],
                            ['font', ['bold', 'italic', 'underline', 'clear']],
                            ['para', ['ul', 'ol', 'paragraph']],
                            ['insert', ['link', 'hr']],
                            ['view', ['codeview']]
                        ]
                    });
                    {% if 83|instancePermissions %}
                    $('#saveTermsAndPayment').on('click', function() {
                        ajaxcall("instances/editInstance.php", {
                            'formData': [
                                { 'name': 'instances_termsAndPayment','value':$('#instances_termsAndPayment').summernote('code') },
                                { 'name': 'instances_quoteTerms','value':$('#instances_quoteTerms').summernote('code') }
                            ]
                        }, function (data) {
                            location.reload();
                        }, false);
                    });
                    {% endif %}
                });
            </script>
        </div>
        <div class="card ">
            <form id="cableColours">
                <div class="card-header">
                    <h3 class="card-title">Cable Colours</h3>
                </div>
                <div class="card-body" style="padding:0;">
                    <table class="table" border="0">
                        <tr>
                            <th>
                                Length
                            </th>
                            <th>
                                Colour
                            </th>
                        </tr>
                        {% for length,colour in USERDATA.instance['instances_cableColours']|cableColourConfig %}
                        <tr>
                            <td>
                                <input type="number" class="form-control" data-type="length" value="{{ length }}">
                            </td>
                            <td>
                                <input type="text" class="form-control colorpicker" data-type="colour" value="{{ colour['background'] }}">
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                <div class="card-footer">
                    {% if 83|instancePermissions %}
                    <button type="button" class="btn btn-default" id="addNewCableColourOption">Add Row</button>
                    <button type="submit" class="btn btn-default">Save</button>
                    {% endif %}
                </div>
            </form>
            <script>
                $(document).ready(function() {
                    $(".colorpicker").spectrum({
                        showInput: true,
                        preferredFormat: "hex",
                    });
                    $("#addNewCableColourOption").on("click", function(){
                        $("#cableColours > div > table").append(`<tr>
                            <td>
                                <input type="number" class="form-control" data-type="length">
                            </td>
                            <td>
                                <input type="text" class="form-control colorpicker" data-type="colour">
                            </td>
                        </tr>`);
                        $(".colorpicker").spectrum({
                            showInput: true,
                            preferredFormat: "hex",
                        });
                    });
                    $("#cableColours").on("submit", function(e){
                        e.preventDefault();
                        var lastLength;
                        var formData = {};
                        $('#cableColours *').filter(':input').each(function(){
                            if ($(this).data("type") == "colour") {
                                if (lastLength != "" && $(this).val()) {
                                    formData[lastLength] = {
                                        "background": $(this).val(),
                                        "text":invert($(this).val(),true)
                                    }
                                }
                            } else {
                                lastLength = $(this).val();
                            }
                        });
                        var formData = [{"name": "instances_cableColours", "value":JSON.stringify(formData) }];
                        ajaxcall("instances/editInstance.php", {formData});
                    });
                });
            </script>
        </div>
        <div class="card">
            <form id="asstStatuses">
                <div class="card-header">
                    <h3 class="card-title">Asset Status</h3>
                </div>
                <div class="card-body">
                    <table class="table table-borderless" id="statusTable">
                        {% for status in USERDATA.instance['assetStatus'] %}
                            <tbody value="{{ status.assetsAssignmentsStatus_id }}">
                                <tr class="row border">
                                    {% if 83|instancePermissions %}
                                    <td class="border-right">
                                        <span class="handle">
                                            <i class="fas fa-ellipsis-v"></i>
                                            <i class="fas fa-ellipsis-v"></i>
                                        </span>
                                    </td>
                                    {% endif %}
                                    <td class="w-75">
                                        <input type="text" class="assetStatusName form-control" name="{{ status.assetsAssignmentsStatus_id }}" value="{{ status.assetsAssignmentsStatus_name }}" />
                                    </td>
                                    <td class="text-right border-left">
                                        <button type="button" class="btn btn-danger" onclick="removeStatus({{ status.assetsAssignmentsStatus_id }})"><i class="fa fa-trash"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        {% endfor %}
                    </table>
                </div>
                <div class="card-footer">
                    {% if 83|instancePermissions %}
                        <button type="button" class="btn btn-default" id="newStatus">Add Row</button>
                    {% endif %}
                </div>
            </form>
            {% if 83|instancePermissions %}
            <script>
                $(document).ready(function () {
                    $("#statusTable").sortable({
                        handle: ".handle",
                        connectWith: "tr",
                        update: function( event, ui ){
                            ajaxcall("instances/assetAssignmentStatus/reorder.php", {
                                "order": $("#statusTable").sortable('toArray', {attribute: 'value'})
                            }, null, true);
                        }
                    });
                    $("#newStatus").on("click", function () {
                        bootbox.prompt({
                            title: "Create New Asset Status",
                            inputType: "text",
                            callback: function (result) {
                                ajaxcall(
                                    "instances/assetAssignmentStatus/new.php",
                                    {"statusName": result, "statusOrder": {{ (USERDATA.instance['assetStatus']|last).assetsAssignmentsStatus_order + 1 }}},
                                    function (returned) {
                                        if (returned['result']) {
                                            window.location.reload();
                                        }
                                    },
                                    true
                                );
                            }
                        });
                    });
                    $(".assetStatusName").on("focusout", function () {
                        ajaxcall(
                            "instances/assetAssignmentStatus/edit.php",
                            {"statusName": $(this)[0].value, "statusId": $(this)[0].name},
                            null,
                            true
                        );
                    });
                });
                function removeStatus(statusID){
                    ajaxcall("instances/assetAssignmentStatus/delete.php",
                        {"statusId": statusID},
                        function (returned) {
                            if (returned['result']) {
                                window.location.reload();
                            }
                        },
                        true
                    );
                }
            </script>
            {% endif %}
        </div>
        <div class="card">
            <form id="advancedSettings">
                <div class="card-header">
                    <h3 class="card-title">Week Start Dates</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <textarea required class="form-control" rows="6" name="instances_weekStartDates">{{ USERDATA.instance.instances_weekStartDates }}</textarea>
                        <i>Enter one date on each line in the format "30 August 2019" for this to re-set the week counter on the calendar. This is normally used by schools and universities</i>
                    </div>
                </div>
                <div class="card-footer">
                    {% if 83|instancePermissions %}
                    <button type="submit" class="btn btn-default">Save</button>
                    {% endif %}
                </div>
            </form>
            <script>
                $(document).ready(function() {
                    $("#advancedSettings").on("submit", function(e){
                        e.preventDefault();
                        var formData = $("#advancedSettings").serializeArray();
                        ajaxcall("instances/editInstance.php", {formData});
                    });
                });
            </script>
        </div>
   </div>
    <div class="col-12 col-md-4">
        <div class="card ">
            <div class="card-header">
                <h3 class="card-title">Logo</h3>
            </div>
            <div class="card-body">
                {% if USERDATA.instance.instances_logo != null %}
                    <img src="{{ USERDATA.instance.instances_logo|s3URL("medium") }}" style="width: 100%;">
                {% else %}
                    <i>None currently set</i>
                {% endif %}
            </div>
            {% if 83|instancePermissions %}
            <div class="card-footer">
                <b>Logos are publicly accessible</b>
                {% embed 'common/plugins/uppy.twig' with {'publicBool': true, 'type': 'INSTANCE-THUMBNAIL', 'paste': false, 'typeId': 5, 'subTypeId': USERDATA.instance.instances_id, 'fileLimit': 1, 'imagesOnly': true } %}
                    {% block success %}
                        ajaxcall("instances/editInstance.php", {
                            'formData': [{ 'name': 'instances_logo','value':responseJson.id }]
                        }, function (data) {
                            location.reload();
                        });
                    {% endblock %}
                {% endembed %}
            </div>
            {% endif %}
        </div>
        <div class="card ">
            <div class="card-header">
                <h3 class="card-title">Email Header</h3>
            </div>
            <div class="card-body">
                {% if USERDATA.instance.instances_emailHeader != null %}
                    <img src="{{ USERDATA.instance.instances_emailHeader|s3URL("medium") }}" style="width: 100%;">
                {% else %}
                    <i>None currently set</i>
                {% endif %}
            </div>
            {% if 83|instancePermissions %}
            <div class="card-footer">
                <b>Email Headers are publicly accessible</b>
                {% embed 'common/plugins/uppy.twig' with {'publicBool': true, 'type': 'INSTANCE-EMAILHEADER', 'paste': false, 'typeId': 10, 'subTypeId': USERDATA.instance.instances_id, 'fileLimit': 1, 'imagesOnly': true } %}
                    {% block success %}
                        ajaxcall("instances/editInstance.php", {
                        'formData': [{ 'name': 'instances_emailHeader','value':responseJson.id }]
                        }, function (data) {
                        location.reload();
                        });
                    {% endblock %}
                {% endembed %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}