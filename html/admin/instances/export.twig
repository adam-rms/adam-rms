{% extends "assets/template.twig" %}

{% block content %}
<div class="row">
    <div class="col-12 col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Instance Export</h3>
            </div>
            <div class="card-body">
                <div class="mb-3" id="export-table-container">
                    <label for="export-table">Export What?</label>
                    <select name="export-table" id="export-table" class="form-control">
                        <option selected disabled>Select a table...</option>
                        {% for table in tables %}
                            <option value={{table[1]}}>{{table[0]}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3 d-none" id="export-column-container">
                    <label for="export-columns">Which Columns?</label>
                    <div id="export-column-checkboxes">
                    </div>
                </div>
                <div class="mb-3 d-none" id="export-sorting-container">
                    <label for="export-sorting">Sort By?</label>
                    <div class="row">
                        <div class="col">
                            <div id="export-sort-radios">

                            </div>
                        </div>
                        <div class="col">
                            <div id="export-order-radios">
                                <div class="form-check">
                                    <input onchange="updateOrderOverview()" class="form-check-input" type="radio" name="column-order-direction" id="order-ascending" value="ASC" checked>
                                    <label class="form-check-label" for="order-ascending">
                                        Ascending
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input onchange="updateOrderOverview()" class="form-check-input" type="radio" name="column-order-direction" id="order-descending" value="DESC">
                                    <label class="form-check-label" for="order-descending">
                                        Descending
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Export Overview</h3>
            </div>
            <div class="card-body">
                <ul class="list-group my-2" id="summary-list">
                </ul> 
                <div class="btn-group my-2 d-none" role="group" id="export-buttons">
                    <div class="input-group-text">Export as</div>
                    <button class="btn btn-primary">.CSV</button>
                    <button class="btn btn-success">.XLSX</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$( document ).ready( function () {
    
    //Update every time table is updated
    $('#export-table').on('change', function () {
        //Clear existing content
        $('#summary-list, #export-column-checkboxes, #export-sort-radios').html("");

        //Summary info
        $('#summary-list').append('<li class="list-group-item"><b>Table:</b> '+ this.value +'</li><li class="list-group-item"><b>Columns:</b> <span id="columns-display"><i>None</i></span</li><li class="list-group-item"><b>Sorting:</b> <span id="order-display"><i>None</i></span</li>');

        //get stuff
        ajaxcall("instances/export/getColumns.php", {
            'table_name': this.value
        }, function (data) {
            for (item of data.response){
                $("#export-column-checkboxes").append('<div class="form-check"><input onchange=updateColumnOverview() selected class="form-check-input" type="checkbox" value="'+ item +'" id="column-'+ item +'"><label class="form-check-label" for="column-'+ item +'">'+item+'</label></div>');
                $("#export-sort-radios").append('<div class="form-check"><input onchange=updateOrderOverview() class="form-check-input" type="radio" value="'+ item +'" name="column-order" id="order-'+ item +'"><label class="form-check-label" for="order-'+ item +'">'+item+'</label></div>');
            }
        });
        $("#export-column-container, #export-sorting-container, #export-buttons").removeClass("d-none");        
    });
});

function updateColumnOverview(){
    $('#columns-display').html("");
    checkboxes = []
    $("#export-column-checkboxes input").each(function() {
        if (this.checked) checkboxes.push(this.value);
    });
    if (checkboxes.length > 0) {
        $('#columns-display').html(checkboxes.join(", "));
    } else {
        $('#columns-display').html("<i>None</i>");
    }
}

function updateOrderOverview(){
    $('#order-display').html($('input[name="column-order"]:checked').val() + ", " + $('input[name="column-order-direction"]:checked').val());
}
</script>
{% endblock %}