{% extends "assets/template.twig" %}

{% block htmlIncludes %}
    <!--Sortable-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12 col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Instance Export</h3>
            </div>
            <div class="card-body">
                <div class="mb-3" id="export-table-container">
                    <label for="export-table">Export What?</label>
                    <select name="export-table" id="export-table" class="form-control">
                        <option selected disabled>Select a table...</option>
                        {% for table in tables %}
                            <option value={{table[1]}}>{{table[0]}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="row" id="this-table-container">
            <div class="col d-none" id="export-column-container">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Which Columns?</h4>
                    </div>
                    <div class="card-body">
                        <div id="export-column-checkboxes" class="mx-2">
                            <table class="table table-borderless" id="export-column-table"></table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col d-none" id="export-sorting-container">
                <div class="card">
                    <div class="mb-3">
                        <div class="card-header">
                            <h4 class="card-title">Sort By?</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col">
                                    <div id="export-sort-radios">

                                    </div>
                                </div>
                                <div class="col">
                                    <div id="export-order-radios">
                                        <div class="form-check">
                                            <input onchange="updateOrderOverview()" class="form-check-input" type="radio" name="column-order-direction" id="order-ascending" value="ASC" checked>
                                            <label class="form-check-label" for="order-ascending">
                                                Ascending
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input onchange="updateOrderOverview()" class="form-check-input" type="radio" name="column-order-direction" id="order-descending" value="DESC">
                                            <label class="form-check-label" for="order-descending">
                                                Descending
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4 ">
        <div class="card sticky-top" style="top: 70px;">
            <div class="card-header">
                <h3 class="card-title">Export Overview</h3>
            </div>
            <div class="card-body">
                <ul class="list-group my-2" id="summary-list">
                </ul> 
                <div class="btn-group my-2 d-none" role="group" id="export-buttons">
                    <div class="input-group-text">Export as</div>
                    <button class="btn btn-primary export-button" data-filetype="csv">.CSV</button>
                    <button class="btn btn-success export-button" data-filetype="xlsx">.XLSX</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$( document ).ready( function () {

    $("#export-column-table").sortable({
        handle: ".handle",
        connectWith: "tr",
        update: updateOverview
    });
    
    //Update every time table is updated
    $('#export-table').on('change', function () {
        //Clear existing content
        $('#summary-list, #export-sort-radios').html("");

        //Summary info
        $('#summary-list').append('<li class="list-group-item"><b>Table:</b> '+ this.value +'</li><li class="list-group-item"><b>Columns:</b> <span id="columns-display"><i>None</i></span</li><li class="list-group-item"><b>Sorting:</b> <span id="order-display"><i>None</i></span</li>');

        //get stuff
        ajaxcall("instances/export/getColumns.php", {
            'table_name': this.value
        }, function (data) {
            for (item of data.response){
                $("#export-column-table").append('<tr class="row border" value="' + item + '"><td class="border-right"><span class="handle"><i class="fas fa-ellipsis-v"></i><i class="fas fa-ellipsis-v"></i></span></td><td><div class="form-check"><input onchange="updateOverview()" selected class="form-check-input" type="checkbox" value="'+ item +'" id="column-'+ item +'"><label class="form-check-label" for="column-'+ item +'">'+item+'</label></div></td></tr>');
                $("#export-sort-radios").append('<div class="form-check"><input onchange=updateOverview() class="form-check-input" type="radio" value="'+ item +'" name="column-order" id="order-'+ item +'"><label class="form-check-label" for="order-'+ item +'">'+item+'</label></div>');
            }
        });
        $("#export-column-container, #export-sorting-container").removeClass("d-none");  
    });

    $('.export-button').on('click', function () {
        let filetype = $(this).data("filetype");
        let table = $('#export-table').val();
        let checkboxes = []
        $("#export-column-checkboxes input").each(function() {
            if (this.checked) checkboxes.push(this.value);
        });
        let sort = $('input[name="column-order"]:checked').val();
        let sortDirection = $('input[name="column-order-direction"]:checked').val();

        $.ajax({
            type:'POST',
            url:'{{ CONFIG.ROOTURL }}/api/instances/export/export.php',
            data: {
                "filetype": filetype,
                "table": table,
                "columns": checkboxes,
                "sort": sort,
                "direction": sortDirection,
            },
            dataType:'json'
        }).done(function(response){
            var $a = $("<a>");
            $a.attr("href",response.response.data);
            $("body").append($a);
            $a.attr("download",table + "." + filetype);
            $a[0].click();
            $a.remove();
        });
    });

});

function updateOverview(){
    let showButtons = false;
    $('#columns-display').html("");
    let checkboxes = $("#export-column-checkboxes input:checked").map(function(){return $(this).val();}).get();
    if (checkboxes.length > 0) {
        $('#columns-display').html(checkboxes.join(", "));
        showButtons = true;
    } else {
        $('#columns-display').html("<i>None</i>");
    }
    if ($('input[name="column-order"]:checked').length > 0){
        $('#order-display').html($('input[name="column-order"]:checked').val() + ", " + $('input[name="column-order-direction"]:checked').val());
    } else {
        showButtons = false;
    }

    if (showButtons) {
        $("#export-buttons").removeClass("d-none");  
    } else {
        $("#export-buttons").addClass("d-none");  
    }
    
}
</script>
{% endblock %}