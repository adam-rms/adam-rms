{% extends "assets/template.twig" %}
{% block htmlIncludes %}

    <script src="{{ CONFIG.ASSETCDNURL }}/js/sweetalert2.min.js"></script>
    <link rel="stylesheet"  href="{{ CONFIG.ASSETCDNURL }}/css/sweetAlert2-bootstrap-4.min.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.5/main.min.css" integrity="sha512-1P/SRFqI1do4eNtBsGIAqIZIlnmOQkaY7ESI2vkl+q+hl9HSXmdPqotN0McmeZVyR4AWV+NvkP6pKOiVdY/V5A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.5/main.min.js" integrity="sha512-VyGX7HXwa9yMgIfDPYcj7+XFjtSEzqY7LTf2Tvn2FAf4O6MkD5UzNkrlkMHyLQMbdYfor8SNYKyyeBhTazNgPw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="{{ CONFIG.ASSETCDNURL }}/libs/slick-1.8.1/slick/slick.css" />
    <link rel="stylesheet" href="{{ CONFIG.ASSETCDNURL }}/libs/slick-1.8.1/slick/slick-theme.css" />
    <script type="text/javascript" src="{{ CONFIG.ASSETCDNURL }}/libs/slick-1.8.1/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="{{ CONFIG.ASSETCDNURL }}/libs/slick-1.8.1/slick/slick.min.js"></script>
{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-md-3">
            {% if assets|length == 1 %}
                <div class="card card-secondary card-outline">
                    <div class="card-body box-profile">
                        <h3 class="profile-username text-center">{{ assets[0].assets_tag|aTag }}</h3>
                        {% if assets[0].assets_endDate is not null and assets[0].assets_endDate|date("U") <= "now"|date("U")  %}
                            <div class="alert alert-danger">
                                <h5> <i class="fas fa-archive"></i> Asset Archived</h5>
                                Asset was {{ assets[0].assets_archived }} on {{ assets[0].assets_endDate|date("d/M/Y") }}
                            </div>
                        {% endif %}
                        {% if assets[0]['link'] %}
                            <div class="callout callout-success">
                                Asset is linked to asset <a href="{{ CONFIG.ROOTURL }}/asset.php?id={{ assets[0]['link']['assetTypes_id'] }}&instance={{ASSET_INSTANCE.instances_id}}&asset={{ assets[0]['link']['assets_id'] }}">{{ assets[0]['link']['assets_tag']|aTag }} ({{ assets[0]['link']['assetTypes_name'] }})</a>
                            </div>
                        {% endif %}
                        {% if assets[0]['assets_notes']|length > 0 %}
                            <p>{{ assets[0]['assets_notes']|nl2br }}</p>
                        {% endif %}
                        <ul class="list-group list-group-unbordered mb-3">
                            {% set assetFieldsLength = 0 %}
                            {% for field in asset.fields %}
                                {% if field != "" %}
                                    {% set assetFieldsLength = assetFieldsLength +1 %}{# Build a count of the number of fields use to help editing an asset #}
                                    <li class="list-group-item">
                                        <b>{{field}}</b> <a class="float-right">{{ assets[0]['asset_definableFields_' ~ loop.index] }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            <li class="list-group-item">
                                <b>Mass</b> <a class="float-right">{{ (assets[0]['assets_mass'] ? assets[0]['assets_mass']|mass : (asset.assetTypes_mass != "" and asset.assetTypes_mass != 0 ? asset.assetTypes_mass|mass : '?')) }}</a>
                            </li>
                            <li class="list-group-item">
                                <b>Value</b> <a class="float-right">{{ (assets[0]['assets_value'] ?: asset.assetTypes_value)|money }}</a>
                            </li>
                            <li class="list-group-item">
                                <b>Day Rate</b> <a class="float-right">{{ (assets[0]['assets_dayRate'] ?: asset.assetTypes_dayRate)|money }}</a>
                            </li>
                            <li class="list-group-item">
                                <b>Week Rate</b> <a class="float-right">{{ (assets[0]['assets_weekRate'] ?: asset.assetTypes_weekRate)|money }}</a>
                            </li>
                        </ul>
                        {% if "ASSETS:ARCHIVE"|instancePermissions and (assets[0].assets_endDate is null or assets[0].assets_endDate|date("U") > "now"|date("U"))  and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                            <hr/>
                            <button class="btn btn-warning btn-block archiveAssetButton" data-assetid="{{ assets[0]['assets_id'] }}" style="margin-bottom: 10px;">Archive</button>
                        {% endif %}
                        {% if "ASSETS:DELETE"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                            <button class="btn btn-danger btn-block deleteAssetButton" data-assetid="{{ assets[0]['assets_id'] }}" style="margin-bottom: 10px;">Delete</button>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            <div class="card card-outline">
                <div class="card-body box-profile">
                    {% if asset.thumbnail %}
                    <div class="text-center {{ asset.thumbnail|length > 1 ? 'slick' : '' }}">
                        {% for thumb in asset.thumbnail %}
                            <div>
                                <img class="img-fluid" style="max-height: 340px;"
                                     src="{{ thumb.s3files_id|s3URL("small") }}"
                                     alt="{{asset.assetTypes_name}}">
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <h3 class="profile-username text-center">{{asset.assetTypes_name}}</h3>

                    <ul class="list-group list-group-unbordered mb-3">
                        {% if asset.assetTypes_productLink != null %}
                        <li class="list-group-item">
                            <b>Product Web Link</b> <a class="float-right" href="{{ asset.assetTypes_productLink }}" target="_blank">{{ asset.assetTypes_productLink|length > 25 ? asset.assetTypes_productLink|slice(0, 25) ~ '...': asset.assetTypes_productLink  }}</a>
                        </li>
                        {% endif %}
                        <li class="list-group-item">
                            <b>Category</b> {{ asset.assetCategoriesGroups_name }} - {{ asset.assetCategories_name }}
                        </li>
                        <li class="list-group-item">
                            <b>Manufacturer</b> {{ asset.manufacturers_name }}
                        </li>
                        <li class="list-group-item">
                            <b>Mass</b> <a class="float-right">{{asset.assetTypes_mass != "" and asset.assetTypes_mass != 0 ? asset.assetTypes_mass|mass : "?" }}</a>
                        </li>
                        <li class="list-group-item">
                            <b>Value</b> <a class="float-right">{{ asset.assetTypes_value|money }}</a>
                        </li>
                        <li class="list-group-item">
                            <b>Day Rate</b> <a class="float-right">{{ asset.assetTypes_dayRate|money }}</a>
                        </li>
                        <li class="list-group-item">
                            <b>Week Rate</b> <a class="float-right">{{ asset.assetTypes_weekRate|money }}</a>
                        </li>
                    </ul>
                    {% if asset.oneasset %}
                        <a href="?id={{asset.assetTypes_id}}" class="btn btn-info btn-block"><b>View All</b></a>
                    {% endif %}
                    {% if assets[0].assets_endDate is null or assets[0].assets_endDate|date("U") >= "now"|date("U")  %}
                        {% if "ASSETS:ASSET_BARCODES:VIEW"|instancePermissions  and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
                            <a href="{{ CONFIG.ROOTURL }}/maintenance/barcode.php?type={{ asset.assetTypes_id }}" class="btn btn-default btn-block">Print Barcodes</a>
                        {% endif %}
                    {% endif %}
                    <p>{{asset.assetTypes_description|nl2br}}</p>
                </div>
            </div>
        </div>


        <div class="col-md-9">
            {% if ASSET_INSTANCE.instances_id != USERDATA.instance.instances_id %}
                <div class="alert alert-info">
                    <h5>Showing assets from business {{ ASSET_INSTANCE.instances_name }}</h5>
                </div>
            {% endif %}
            {% if assets|length == 1 %}
                {% for flag in assets[0].flagsblocks.BLOCK %}
                    <div class="alert alert-danger">
                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button" style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                        <h5> <i class="fas fa-ban"></i> {{ flag.maintenanceJobs_title }}</h5>
                        {{ flag.maintenanceJobs_faultDescription }}
                    </div>
                {% endfor %}
                {% for flag in assets[0].flagsblocks.FLAG %}
                    <div class="alert alert-warning">
                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button"  style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                        <h5><i class="far fa-flag"></i> {{ flag.maintenanceJobs_title }}</h5>
                        {{ flag.maintenanceJobs_faultDescription }}
                    </div>
                {% endfor %}
                {% if assets[0]['linkedToThis'] %}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Assets linked to this asset</h3>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for asset in assets[0]['linkedToThis'] %}
                                <tr>
                                    <td><a href="{{ CONFIG.ROOTURL }}/asset.php?id={{ asset['assetTypes_id'] }}&instance={{ASSET_INSTANCE.instances_id}}&asset={{ asset['assets_id'] }}">{{ asset['assets_tag']|aTag }}</a></td>
                                    <td>
                                        {% for i in range(1, asset['tier']) %}
                                            {% if i == 1 %}
                                            {% elseif loop.last %}
                                            &#8627;
                                            {% else %}
                                            &nbsp;
                                            {% endif %}
                                        {% endfor %}
                                        {{ asset['assetTypes_name'] }}</a>
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
            {% if assets|length == 1 and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
            <div class="card card-secondary card-outline">
                <div class="card-header p-2">
                    <ul class="nav nav-pills">
                        <li class="nav-item"><a class="nav-link active" href="#calendarBoxAsset" data-toggle="tab"><i class="far fa-calendar-alt"></i></a></li>
                        {% if "ASSETS:EDIT"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#editAsset" data-toggle="tab">Edit {{ assets[0].assets_tag|aTag }}</a></li>{% endif %}
                        {% if "ASSETS:ASSET_FILE_ATTACHMENTS:VIEW"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#files" data-toggle="tab">Asset Files</a></li>{% endif %}
                        {% if "ASSETS:ASSET_BARCODES:VIEW"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#barcodes" data-toggle="tab">Barcodes</a></li>{% endif %}
                        {% if  "MAINTENANCE_JOBS:VIEW"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#maintenance" data-toggle="tab">Maintenance</a></li>{% endif %}
                    </ul>
                </div><!-- /.card-header -->
                <div class="card-body" style="padding: 0;">
                    <div class="tab-content">
                        <div class="active tab-pane" style="padding: 1.25rem" id="calendarBoxAsset">
                            <div id="calendar"></div>
                            <script>
                                $(function () {
                                    /* initialize the calendar
                                     -----------------------------------------------------------------*/
                                    var Calendar = FullCalendar.Calendar;

                                    var calendarEl = document.getElementById('calendar');

                                    // initialize the external events
                                    // -----------------------------------------------------------------

                                    var calendar = new Calendar(calendarEl, {
                                        themeSystem: 'bootstrap',
                                        buttonText:  {
                                            today:    'Today',
                                            month:    'Month',
                                            week:     'Week',
                                            day:      'Day',
                                            list:     'List'
                                        },
                                        headerToolbar : {
                                            left  : 'prev,next today',
                                            center: 'title',
                                            right : 'dayGridMonth,timeGridWeek'
                                        },
                                        //Random default events
                                        events    : [
                                            {% set earliestStart = false %}
                                            {% set latestEnd = false %}
                                            {% for thisasset in assets %}
                                            {% for assignment in thisasset.assignments %}
                                            {
                                                title          : '{{ thisasset.assets_tag|aTag }} [{{ assignment.projectsStatuses_name|escape("js") }}] {{ assignment.projects_name }}',
                                                start          : Date.parse("{{ assignment.projects_dates_deliver_start|date("c") }}"),
                                                end            : Date.parse("{{ assignment.projects_dates_deliver_end|date("c") }}"),
                                                url            : '{{CONFIG.ROOTURL}}/project/?id={{ assignment.projects_id }}',
                                                backgroundColor: '{{ assignment.projectsStatuses_backgroundColour }}',
                                                textColor    : '{{ assignment.projectsStatuses_foregroundColour }}'
                                            },
                                            {% if earliestStart > assignment.projects_dates_deliver_start|date("c") or earliestStart == false %}
                                            {% set earliestStart = assignment.projects_dates_deliver_start|date("c") %}
                                            {% endif %}
                                            {% if latestEnd < assignment.projects_dates_deliver_end|date("c") or latestEnd == false %}
                                            {% set latestEnd = assignment.projects_dates_deliver_end|date("c") %}
                                            {% endif %}
                                            {% endfor %}
                                            {% endfor %}
                                        ],
                                        validRange: {
                                            start: '{{ earliestStart|date("c") }}',
                                            end: '{{ latestEnd|date("c") }}'
                                        },
                                        editable  : false,
                                        droppable : false, // this allows things to be dropped onto the calendar !!!
                                        drop      : function(info) {

                                        },
                                        height: 600,
                                        firstDay: 1,
                                    });

                                    calendar.render();
                                })
                            </script>
                        </div>
                        {% if "ASSETS:EDIT"|instancePermissions %}
                            <div class="tab-pane" style="padding:0"  id="editAsset">
                                <div class="card" style="margin-bottom:0;">
                                    <div class="card-header p-2">
                                        <ul class="nav nav-pills">
                                            <li class="nav-item"><a class="nav-link active" href="#editAssetDetails" data-toggle="tab">Details</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#linked" data-toggle="tab">Asset Link</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#groups" data-toggle="tab">Groups</a></li>
                                            {% if assetFieldsLength > 0 %}<li class="nav-item"><a class="nav-link" href="#editAssetFields" data-toggle="tab">Custom Fields</a></li>{% endif %}
                                            {% if "ASSETS:EDIT:OVVERRIDES"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#editAssetDetailsOverrides" data-toggle="tab">Asset Type Overrides</a></li>{% endif %}
                                            <li class="nav-item"><a class="nav-link" href="#editAssetType" data-toggle="tab">Change Type</a></li>
                                            {% if "ASSETS:TRANSFER"|instancePermissions and assets[0].assets_endDate is null %}<li class="nav-item"><a class="nav-link" href="#moveAsset" data-toggle="tab">Transfer Asset</a></li>{% endif %}
                                        </ul>
                                    </div><!-- /.card-header -->
                                    <div class="card-body" style="padding: 0;">
                                        <div class="tab-content">
                                            <div class="active tab-pane" style="padding: 1.25rem" id="editAssetDetails">
                                                <form id="editAssetDetailsForm">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Asset ID</span></div>
                                                        <input class="form-control" name="assets_tag" value="{{ assets[0]['assets_tag'] }}" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Asset Notes</span></div>
                                                        <textarea class="form-control" rows="2" name="assets_notes" placeholder="">{{ assets[0]['assets_notes'] }}</textarea>
                                                    </div>
                                                </form>
                                                <button class="btn btn-default float-right" id="saveAssetSettingsButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            <div class="tab-pane" style="padding: 1.25rem" id="linked">
                                                <div class="callout">
                                                    Linking this asset to another means that whenever that asset is added to a project this asset is also added. For example, you might link an assets power supply to the asset
                                                </div>
                                                {% if USERDATA.instance.instances_config_linkedDefaultDiscount > 0 %}
                                                    <div class="callout callout-danger">
                                                        When linked assets are added to a project they are discounted by {{ USERDATA.instance.instances_config_linkedDefaultDiscount }}% by default
                                                    </div>
                                                {% endif %}
                                                <select class="form-control select2bs4 assetSelect2" id="assetLinkChange">
                                                    {% if assets[0]['assets_linkedTo'] %}
                                                        <option value="{{ assets[0]['assets_linkedTo'] }}" selected>{{ assets[0]['link']['assets_tag']|aTag }} ({{ assets[0]['link']['assetTypes_name'] }})</option>
                                                    {% endif %}
                                                </select>
                                                <button class="btn btn-default float-right" id="saveAssetLinkChangeButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                                {% if assets[0]['assets_linkedTo'] %}
                                                    <button class="btn btn-warning float-right" id="removeAssetLinkChangeButton" style="margin-top:10px;margin-bottom:10px;">Remove Link</button>
                                                {% endif %}

                                            </div>
                                            <div class="tab-pane" style="padding: 1.25rem" id="groups">
                                                <select class="form-control" id="assetGroups" multiple>
                                                    {% for group in assets[0]['groups'] %}
                                                        <option value="{{ group.assetGroups_id }}" selected="selected">{{group.assetGroups_name}}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="tab-pane" style="padding: 1.25rem" id="editAssetFields">
                                                <form id="editAssetDefinableFieldsForm">
                                                    {% for field in asset.fields %}
                                                        {% if field != "" %}
                                                            <div class="input-group definableFieldsGroup" data-fieldcount="{{loop.index}}">
                                                                <div class="input-group-prepend"><span class="input-group-text">{{field}}</span></div>
                                                                <input type="text" class="definableFieldsInput form-control" name="asset_definableFields_{{ loop.index }}" value="{{ assets[0]['asset_definableFields_' ~ loop.index] }}" data-fieldcount="{{loop.index}}" />
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </form>
                                                <button class="btn btn-default float-right" id="saveAssetDefinableFieldButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            {% if "ASSETS:EDIT:OVVERRIDES"|instancePermissions %}
                                                <div class="tab-pane" style="padding: 1.25rem" id="editAssetDetailsOverrides">
                                                    <div class="callout">
                                                        Overriding the details of the asset means that these settings below will take precedence over the properties for the type - this allows you to have multiple assets within a type with different masses for example
                                                    </div>
                                                    <form id="editAssetDetailsOverridesForm">
                                                        <div class="input-group">
                                                            <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Mass
                                                    </span>
                                                            </div>
                                                            <input type="number" step="0.001" min="0" name="assets_mass" value="{{ assets[0].assets_mass }}" class="form-control" />
                                                            <div class="input-group-append">
                                                                <div class="input-group-text">kg</div>
                                                            </div>
                                                        </div>
                                                        <div class="input-group">
                                                            <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Value - £
                                                    </span>
                                                            </div>
                                                            <input type="number" step="0.001" min="0" name="assets_value" value="{{ assets[0].assets_value|moneyDecimal }}" class="form-control" />
                                                        </div>

                                                        <div class="input-group">
                                                            <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Day Rate - £
                                                    </span>
                                                            </div>
                                                            <input type="number" step="0.001" min="0" name="assets_dayRate" value="{{ assets[0].assets_dayRate|moneyDecimal }}" class="form-control"  />
                                                        </div>
                                                        <div class="input-group">
                                                            <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                              Weekly Rate - £
                                                            </span>
                                                            </div>
                                                            <input type="number" step="0.001" min="0" name="assets_weekRate" class="form-control" value="{{ assets[0].assets_weekRate|moneyDecimal }}" />
                                                        </div>
                                                    </form>
                                                    <button class="btn btn-default float-right" id="editAssetDetailsOverridesButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                                </div>
                                            {% endif %}
                                            <div class="tab-pane" style="padding: 1.25rem" id="editAssetType">
                                                <div class="callout callout-danger">
                                                    Changing the asset type for this asset can have significant implications especially with cost of existing projects and definable fields
                                                </div>
                                                <select class="form-control  select2bs4 assetSelect2" id="assetTypeChange" placeholder="{{ asset.assetTypes_name }}" value="{{ asset.assetTypes_id }}"></select>
                                                <button class="btn btn-default float-right" id="saveAssetTypeChangeButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            {% if "ASSETS:TRANSFER"|instancePermissions %}
                                            <div class="tab-pane" style="padding: 1.25rem" id="moveAsset">
                                                <div class="callout callout-danger">
                                                    <p>Transferring an asset to another business will remove it from this business, which will affect existing projects.</p>
                                                    <p>You can only transfer assets if you have the <code>ASSETS:TRANSFER</code> permission for the business you are transfering the asset into.</p>
                                                </div>
                                                <div class="form-group">
                                                    <label for="assetMigrateInstance">Business to transfer asset to</label>
                                                    <select class="form-control select2bs4" id="assetMigrateInstance" placeholder="Select an Instance"></select>
                                                </div>
                                                <div class="form-group" style="display: none;">
                                                    <label for="assetMigrateAssetType">Asset Type for asset in new business</label>
                                                    <select class="form-control select2bs4" id="assetMigrateAssetType" placeholder="Select an Asset Type"></select>
                                                </div>
                                                <div class="form-group mt-2" style="display: none;">
                                                    <label for="assetMigrateManufacturer">New Asset Type Manufacturer</label>
                                                    <select class="form-control select2bs4" id="assetMigrateManufacturer" placeholder="Select a Manufacturer" aria-describedby="assetMigrateManufacturerHelp"></select>
                                                    <small id="assetMigrateManufacturerHelp" class="form-text text-muted">Select the manufacturer that this copied asset type should use</small>
                                                </div>
                                                <div class="form-group" style="display: none;">
                                                    <label for="assetMigrateCategory">New Asset Type Category</label>
                                                    <select class="form-control select2bs4" id="assetMigrateCategory" placeholder="Select a Category" aria-describedby="assetMigrateCategoryHelp"></select>
                                                    <small id="assetMigrateCategoryHelp" class="form-text text-muted">Which category should this asset type be placed in?</small>
                                                </div> 
                                                <button class="btn btn-default float-right" id="assetMigrate" style="margin-top:10px;margin-bottom:10px;">Migrate</button>                 
                                            </div>
                                            {% endif %}
                                        </div>
                                        <!-- /.tab-content -->
                                    </div><!-- /.card-body -->
                                </div>
                            </div>
                        {% endif %}

                        {% if "ASSETS:ASSET_FILE_ATTACHMENTS:VIEW"|instancePermissions %}
                            <div class="tab-pane" style="padding: 1.25rem"  id="files">
                                {% if "ASSETS:ASSET_FILE_ATTACHMENTS:CREATE"|instancePermissions %}
                                    <div class="callout callout-default">
                                        Use this area to store files relevant to one asset such as an order confirmation or purchase invoice
                                    </div>
                                    {% embed 'common/plugins/uppy.twig' with {'type': 'ASSET-FILE', 'paste': false, 'typeId': 4, 'subTypeId': assets[0]['assets_id'], 'imagesOnly': false } %}
                                        {% block success %}
                                            console.log(responseJson.id);
                                        {% endblock %}
                                    {% endembed %}
                                    <br/>
                                {% endif %}
                                {% embed 'common/plugins/fileBox.twig' with {'files': assets[0]['files'] } %}
                                {% endembed %}
                            </div>
                        {% endif %}
                        {% if "ASSETS:ASSET_BARCODES:VIEW"|instancePermissions  %}
                            <div class="tab-pane" style="padding: 0" id="barcodes">
                                <table class="table table-striped projects">
                                    <thead>
                                    <tr>
                                        <th>

                                        </th>
                                        <th>
                                            Notes
                                        </th>
                                        <th>
                                            Creator
                                        </th>
                                        <th>
                                            Last Scanned
                                        </th>
                                        <th style="width:1%;">

                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for barcode in assets[0].barcodes %}
                                        <tr>
                                            <td>
                                                <img src="{{ CONFIG.ROOTURL }}/api/assets/barcodes/?barcode={{ barcode.assetsBarcodes_value }}&size=50&type={{ barcode.assetsBarcodes_type }}" alt="Barcode">
                                            </td>
                                            <td>
                                                {{ barcode.assetsBarcodes_notes }}
                                            </td>
                                            <td>
                                                <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ barcode.users_userid }}">
                                                    {{ barcode.users_name1 ~ ' ' ~ barcode.users_name2}}
                                                </a>
                                                <br/>
                                                <small>
                                                    Created {{barcode.assetsBarcodes_added|date("d M Y h:i:sa")}}
                                                </small>
                                            </td>
                                            <td>
                                                {% if barcode.latestScan %}
                                                    {% if barcode.latestScan.locations_name %}
                                                        {{ barcode.latestScan.locations_name }} <span class="badge badge-default" title="GPS Not Verified, but location barcode scanned"><i class="fas fa-map-marker-alt"></i></span>
                                                    {% elseif barcode.latestScan.assetTypes_name %}
                                                        {{  barcode.latestScan.assetTypes_name }} <span class="badge badge-info" title="Asset Scan was Verified"><i class="fas fa-check"></i></span>
                                                    {% elseif barcode.latestScan.assetsBarcodes_customLocation %}
                                                        {{  barcode.latestScan.assetsBarcodes_customLocation }} <span class="badge badge-danger" title="Location was entered as text"><i class="fas fa-times"></i></span>
                                                    {% endif %}
                                                    <span class="badge badge-secondary" title="Scanned by {{ barcode.latestScan.users_name1 ~ " " ~ barcode.latestScan.users_name2 }}  {{ barcode.latestScan.assetsBarcodesScans_timestamp|date("d/M/Y G:i:s") }}"><i class="fas fa-info"></i></span>
                                                {% else %}
                                                    <i>Never scanned</i>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if "ASSETS:ASSET_BARCODES:DELETE"|instancePermissions %}
                                                    <button title="Delete" class="btn btn-sm btn-danger deleteBarcodeButton" data-barcodeid="{{ barcode['assetsBarcodes_id'] }}"><i class="fa fa-trash"></i></button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                        {% if "MAINTENANCE_JOBS:VIEW"|instancePermissions %}
                            <div class="tab-pane" style="padding:0"  id="maintenance">
                                <div class="card" style="margin-bottom:0;">
                                    <div class="card-header p-2">
                                        <ul class="nav nav-pills">
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-newJob" data-toggle="tab">New Job</a></li>
                                            <li class="nav-item"><a class="nav-link active" href="#maintenance-flags" data-toggle="tab">Blocks &amp; Flags</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-jobsOutstanding" data-toggle="tab">Jobs Outstanding</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-jobsCompleted" data-toggle="tab">Jobs Completed</a></li>
                                        </ul>
                                    </div><!-- /.card-header -->
                                    <div class="card-body" style="padding: 0;">
                                        <div class="tab-content">
                                            <div class="tab-pane" style="padding: 1.25rem" id="maintenance-newJob">
                                                <style>
                                                    .input-group {
                                                        margin-bottom: 5px;
                                                    }
                                                </style>
                                                <form id="addNewJobForm">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Asset</span></div>
                                                        <input type="text" class="form-control" disabled value="{{ assets[0].assets_tag|aTag }}" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Title</span></div>
                                                        <input type="text" class="form-control" name="maintenanceJobs_title" id="maintenanceJobstitle" placeholder="Drum revolve key missing" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Fault Description</span></div>
                                                        <textarea class="form-control" rows="5" name="maintenanceJobs_faultDescription" id="maintenanceJobsfaultDescription" placeholder="Details of the fault"></textarea>
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                              Priority
                                                            </span>
                                                        </div>
                                                        <select class="form-control" name="maintenanceJobs_priority">
                                                            {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                <option value="{{ type.id }}" {% if type.default %}selected{% endif %}>{{ type.text }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="input-group">
                                                        <label>Tag Users</label>
                                                        <select class="form-control" multiple="multiple" placeholder="Select users to be tagged for updates in the job" id="tagUserInJob">
                                                        </select>
                                                    </div>
                                                </form>

                                                <button class="btn btn-default float-right" id="addNewJobButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            <div class="active tab-pane" style="padding: 1.25rem" id="maintenance-flags">
                                                {% for flag in assets[0].flagsblocks.BLOCK %}
                                                    <div class="alert alert-danger">
                                                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button" style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                                                        <h5><i class="fas fa-ban"></i> {{ flag.maintenanceJobs_title }}</h5>
                                                        {{ flag.maintenanceJobs_faultDescription }}
                                                    </div>
                                                {% endfor %}
                                                {% for flag in assets[0].flagsblocks.FLAG %}
                                                    <div class="alert alert-warning">
                                                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button"  style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                                                        <h5><i class="far fa-flag"></i> {{ flag.maintenanceJobs_title }}</h5>
                                                        {{ flag.maintenanceJobs_faultDescription }}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            <div class="tab-pane" style="padding: 0;" id="maintenance-jobsOutstanding">
                                                <table class="table table-striped projects">
                                                    <thead>
                                                    <tr>
                                                        <th style="width: 1%">
                                                            #
                                                        </th>
                                                        <th>
                                                            Title
                                                        </th>
                                                        <th style="width: 5%">
                                                            Creator
                                                        </th>
                                                        <th style="width: 5%">
                                                            Assigned
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Priority
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Status
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-flag"></i>
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-ban"></i>
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for job in assets[0].jobs %}
                                                        {% if job.maintenanceJobsStatuses_id != 2 %}
                                                            <tr>
                                                                <td>
                                                                    <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ job.maintenanceJobs_id }}">#{{ job.maintenanceJobs_id }}</a>
                                                                </td>
                                                                <td>
                                                                    <a>
                                                                        {{ job.maintenanceJobs_title }}
                                                                    </a>
                                                                    <br/>
                                                                    <small>
                                                                        Created {{job.maintenanceJobs_timestamp_added|date("d M Y h:i:sa")}}
                                                                    </small>
                                                                </td>
                                                                <td>
                                                                    <ul class="list-inline">
                                                                        <li class="list-inline-item">
                                                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userCreatorUserID }}" title="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 ~ " (" ~ job.userCreatorUserEMail ~ ")" }}">
                                                                                <img alt="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 }}" class="table-avatar" src="{{ job.userCreatorUserThumb ? job.userCreatorUserThumb|s3URL("small") : CONFIG.ASSETCDNURL ~ '/img/default-profile-picture.jpg' }}">
                                                                            </a>
                                                                        </li>
                                                                    </ul>
                                                                </td>
                                                                <td>
                                                                    {% if job.userAssignedUserName1 != null %}
                                                                        <ul class="list-inline">
                                                                            <li class="list-inline-item">
                                                                                <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userAssignedUserID }}" title="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 ~ " (" ~ job.userAssignedUserEMail ~ ")" }}">
                                                                                    <img alt="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}" class="table-avatar" src="{{ job.userAssignedUserThumb ? job.userAssignedUserThumb|s3URL("small") : CONFIG.ASSETCDNURL ~ '/img/default-profile-picture.jpg' }}">
                                                                                </a>
                                                                            </li>
                                                                        </ul>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobs_priority %}
                                                                        {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                            <span class="badge badge-{{ type.class }}" value="{{ type.id }}" {% if job.maintenanceJobs_priority != type.id %} style="display: none;" {% endif %}>{{ type.text }}</span>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobsStatuses_name %}
                                                                        <span class="badge badge-default">{{ job.maintenanceJobsStatuses_name }}</span>
                                                                    {% else %}
                                                                        <span class="badge badge-default">Awaiting Sorting</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_flagAssets == 1 %}
                                                                        <i class="fas fa-flag"></i>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_blockAssets == 1 %}
                                                                        <i class="fas fa-ban"></i>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="tab-pane" style="padding: 0" id="maintenance-jobsCompleted">
                                                <table class="table table-striped projects">
                                                    <thead>
                                                    <tr>
                                                        <th style="width: 1%">
                                                            #
                                                        </th>
                                                        <th>
                                                            Title
                                                        </th>
                                                        <th style="width: 5%">
                                                            Creator
                                                        </th>
                                                        <th style="width: 5%">
                                                            Assigned
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Priority
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Status
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-flag"></i>
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-ban"></i>
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for job in assets[0].jobs %}
                                                        {% if job.maintenanceJobsStatuses_id == 2 %}
                                                            <tr>
                                                                <td>
                                                                    <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ job.maintenanceJobs_id }}">#{{ job.maintenanceJobs_id }}</a>
                                                                </td>
                                                                <td>
                                                                    <a>
                                                                        {{ job.maintenanceJobs_title }}
                                                                    </a>
                                                                    <br/>
                                                                    <small>
                                                                        Created {{job.maintenanceJobs_timestamp_added|date("d M Y h:i:sa")}}
                                                                    </small>
                                                                </td>
                                                                <td>
                                                                    <ul class="list-inline">
                                                                        <li class="list-inline-item">
                                                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userCreatorUserID }}" title="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 ~ " (" ~ job.userCreatorUserEMail ~ ")" }}">
                                                                                <img alt="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 }}" class="table-avatar" src="{{ job.userCreatorUserThumb ? job.userCreatorUserThumb|s3URL("small") : CONFIG.ASSETCDNURL ~ '/img/default-profile-picture.jpg' }}">
                                                                            </a>
                                                                        </li>
                                                                    </ul>
                                                                </td>
                                                                <td>
                                                                    {% if job.userAssignedUserName1 != null %}
                                                                        <ul class="list-inline">
                                                                            <li class="list-inline-item">
                                                                                <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userAssignedUserID }}" title="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 ~ " (" ~ job.userAssignedUserEMail ~ ")" }}">
                                                                                    <img alt="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}" class="table-avatar" src="{{ job.userAssignedUserThumb ? job.userAssignedUserThumb|s3URL("small") : CONFIG.ASSETCDNURL ~ '/img/default-profile-picture.jpg' }}">
                                                                                </a>
                                                                            </li>
                                                                        </ul>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobs_priority %}
                                                                        {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                            <span class="badge badge-{{ type.class }}" value="{{ type.id }}" {% if job.maintenanceJobs_priority != type.id %} style="display: none;" {% endif %}>{{ type.text }}</span>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobsStatuses_name %}
                                                                        <span class="badge badge-default">{{ job.maintenanceJobsStatuses_name }}</span>
                                                                    {% else %}
                                                                        <span class="badge badge-default">Awaiting Sorting</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_flagAssets == 1 %}
                                                                        <i class="fas fa-flag"></i>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_blockAssets == 1 %}
                                                                        <i class="fas fa-ban"></i>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- /.tab-content -->
                                    </div><!-- /.card-body -->
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <!-- /.tab-content -->
                </div><!-- /.card-body -->
            </div>
            {% endif %}
            <div class="card">
                <div class="card-header p-2">
                    <ul class="nav nav-pills">
                        {% if asset.oneasset %}
                            <li class="nav-item"><a class="nav-link" href="?id={{asset.assetTypes_id}}&instance={{ASSET_INSTANCE.instances_id}}">View All</a></li>
                        {% elseif assets|length > 1 %}
                            <li class="nav-item"><a class="nav-link" href="#assets" data-toggle="tab">Assets</a></li>
                        {% endif %}

                        {% if assets|length > 1 and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
                        <li class="nav-item"><a class="nav-link active" href="#calendarBox" data-toggle="tab"><i class="far fa-calendar-alt"></i></a></li>
                        {% endif %}


                        {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                            <li class="nav-item"><a class="nav-link" href="#settings" data-toggle="tab">Edit Type</a></li>
                        {% endif %}
                        {% if "ASSETS:ASSET_TYPE_FILE_ATTACHMENTS:VIEW"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}<li class="nav-item"><a class="nav-link" href="#typeFiles" data-toggle="tab">Type Files</a></li>{% endif %}
                    </ul>
                </div><!-- /.card-header -->
                <div class="card-body" style="padding: 0;">
                    <div class="tab-content">
                        <div class="tab-pane table-responsive p-0" id="assets" style="height: 600px;">
                            <table class="table table-head-fixed">
                                <tr>
                                    <th style="width:70px;">ID</th>
                                    {% for field in asset.fields %}
                                        <th>{{ field }}</th>
                                    {% endfor %}
                                    <th>Notes</th>
                                    <th>Value</th>
                                    <th>&pound;/day</th>
                                    <th>&pound;/week</th>
                                    <th title="File attachments"><i class="fas fa-paperclip"></i></th>
                                    <th style="width:1%"><i class="fas fa-flag"></i></th>
                                    <th style="width:1%"><i class="fas fa-ban"></i></th>
                                    <th style="width:30px;"></th>
                                </tr>
                                {% for thisasset in assets %}
                                    <tr>
                                        <td><a href="?id={{ asset.assetTypes_id }}&asset={{ thisasset.assets_id }}&instance={{ASSET_INSTANCE.instances_id}}">{{ thisasset.assets_tag|aTag }}</a></td>
                                        {% for field in asset.fields %}
                                            <td>{{ thisasset['asset_definableFields_' ~ loop.index] }}</td>
                                        {% endfor %}
                                        <td>{{ thisasset['assets_notes']|nl2br }}</td>
                                        <td>
                                            {{ (thisasset.assets_value ?: asset.assetTypes_value)|money }}
                                        </td>
                                        <td>
                                            {{ (thisasset.assets_dayRate ?: asset.assetTypes_dayRate)|money }}
                                        </td>
                                        <td>
                                            {{ (thisasset.assets_weekRate ?: asset.assetTypes_weekRate)|money }}
                                        </td>
                                        <td>{{ thisasset.files|length > 0 ?: "" }}</td>

                                        <td>
                                            {{ thisasset.flagsblocks.COUNT.FLAG > 0 ?: '' }}
                                        </td>
                                        <td>
                                            {{ thisasset.flagsblocks.COUNT.BLOCK > 0 ?: '' }}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                {% if "ASSETS:ARCHIVE"|instancePermissions and (thisasset.assets_endDate is null or thisasset.assets_endDate|date("U") > "now"|date("U"))  and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
                                                    <button title="Archive" class="btn btn-sm btn-warning archiveAssetButton" data-assetid="{{ thisasset['assets_id'] }}"><i class="fas fa-archive"></i></button>
                                                {% endif %}
                                                {% if "ASSETS:DELETE"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                                                    <button title="Delete" class="btn btn-sm btn-danger deleteAssetButton" data-assetid="{{ thisasset['assets_id'] }}"><i class="fa fa-trash"></i></button>
                                                {% endif %}


                                                <a class="btn btn-sm btn-info" title="View" href="?id={{ asset.assetTypes_id }}&asset={{ thisasset.assets_id }}&instance={{ASSET_INSTANCE.instances_id}}"><i class="far fa-arrow-alt-circle-right"></i></a>
                                                </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                        <!-- /.tab-pane -->
                        {% if assets|length > 1 %}
                        <div class="active tab-pane" style="padding: 1.25rem" id="calendarBox">
                            <div id="calendar"></div>
                            <script>
                                $(function () {
                                    /* initialize the calendar
                                     -----------------------------------------------------------------*/
                                    var Calendar = FullCalendar.Calendar;

                                    var calendarEl = document.getElementById('calendar');

                                    // initialize the external events
                                    // -----------------------------------------------------------------

                                    var calendar = new Calendar(calendarEl, {
                                        themeSystem: 'bootstrap',
                                        buttonText:  {
                                            today:    'Today',
                                            month:    'Month',
                                            week:     'Week',
                                            day:      'Day',
                                            list:     'List'
                                        },
                                        headerToolbar : {
                                            left  : 'prev,next today',
                                            center: 'title',
                                            right : 'dayGridMonth'
                                        },
                                        //Random default events
                                        events    : [
                                            {% set earliestStart = false %}
                                            {% set latestEnd = false %}
                                            {% for thisasset in assets %}
                                                {% for assignment in thisasset.assignments %}
                                                {
                                                    title          : '[{{ assignment.projectsStatuses_name }}] {{ assignment.projects_name }}',
                                                    start          : Date.parse("{{ assignment.projects_dates_deliver_start|date("c") }}"),
                                                    end            : Date.parse("{{ assignment.projects_dates_deliver_end|date("c") }}"),
                                                    url            : '{{CONFIG.ROOTURL}}/project/?id={{ assignment.projects_id }}',
                                                    backgroundColor: '{{ assignment.projectsStatuses_backgroundColour }}',
                                                    textColor    : '{{ assignment.projectsStatuses_foregroundColour }}'
                                                },
                                                {% if earliestStart > assignment.projects_dates_deliver_start|date("c") or earliestStart == false %}
                                                    {% set earliestStart = assignment.projects_dates_deliver_start|date("c") %}
                                                {% endif %}
                                                {% if latestEnd < assignment.projects_dates_deliver_end|date("c") or latestEnd == false %}
                                                    {% set latestEnd = assignment.projects_dates_deliver_end|date("c") %}
                                                {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        ],
                                        validRange: {
                                            start: '{{ earliestStart|date("c") }}',
                                            end: '{{ latestEnd|date("c") }}'
                                        },
                                        editable  : false,
                                        droppable : false, // this allows things to be dropped onto the calendar !!!
                                        drop      : function(info) {

                                        },
                                        height: 600,
                                        firstDay: 1,
                                    });

                                    calendar.render();
                                })
                            </script>
                        </div>
                        {% endif %}
                        {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions and (asset.assetInstances_id != null or "ASSETS:EDIT:ANY_ASSET_TYPE"|serverPermissions) and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                        <div class="tab-pane" style="padding:0"  id="settings">
                            <div class="card" style="margin-bottom:0;">
                                <div class="card-header p-2">
                                    <ul class="nav nav-pills">
                                        <li class="nav-item"><a class="nav-link active" href="#details" data-toggle="tab">Details</a></li>
                                        <li class="nav-item"><a class="nav-link" href="#fields" data-toggle="tab">Custom Fields</a></li>
                                        <li class="nav-item"><a class="nav-link" href="#thumbnail" data-toggle="tab">Thumbnails</a></li>
                                    </ul>
                                </div><!-- /.card-header -->
                                <div class="card-body" style="padding: 0;">
                                    <div class="tab-content">
                                        <div class="active tab-pane" style="padding: 1.25rem" id="details">
                                            <style>
                                                .input-group {
                                                    margin-bottom: 5px;
                                                }
                                            </style>
                                            <form id="addNewForm">
                                            <div class="input-group">
                                                <div class="input-group-prepend"><span class="input-group-text">Name</span></div>
                                                <input type="text" class="form-control" name="assetTypes_name" value="{{ asset.assetTypes_name}}" id="addNewType-name" />
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend"><span class="input-group-text">Description</span></div>
                                                <textarea class="form-control" rows="3" name="assetTypes_description" id="addNewType-description"  placeholder="">{{ asset.assetTypes_description}}</textarea>
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend"><span class="input-group-text">Product Link</span></div>
                                                <input type="url" class="form-control" name="assetTypes_productLink" value="{{ asset.assetTypes_productLink }}" id="addNewType-productLink" />
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Mass
                                                    </span>
                                                </div>
                                                <input type="number" step="0.001" min="0" name="assetTypes_mass" value="{{ asset.assetTypes_mass}}" class="form-control" id="addNewType-mass" />
                                                <div class="input-group-append">
                                                    <div class="input-group-text">kg</div>
                                                </div>
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Value - £
                                                    </span>
                                                </div>
                                                <input type="number" step="0.001" min="0" name="assetTypes_value" value="{{ asset.assetTypes_value|moneyDecimal }}" class="form-control" id="addNewType-value" />
                                            </div>

                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Day Rate - £
                                                    </span>
                                                </div>
                                                <input type="number" step="0.001" min="0" name="assetTypes_dayRate" value="{{ asset.assetTypes_dayRate|moneyDecimal }}" class="form-control" id="addNewType-dayRate" />
                                                <div class="input-group-append">
                                                    <div class="input-group-text" id="addNewType-dayRate-guide">Guide 2% of value</div>
                                                </div>
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Weekly Rate - £
                                                    </span>
                                                </div>
                                                <input type="number" step="0.001" min="0" name="assetTypes_weekRate" class="form-control" value="{{ asset.assetTypes_weekRate|moneyDecimal }}" id="addNewType-weekRate" />
                                                <div class="input-group-append">
                                                    <div class="input-group-text" id="addNewType-weekRate-guide">Guide 6% of value</div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>Category</label>
                                                <select class="form-control  select2bs4 assetSelect2" id="category" name="assetCategories_id">
                                                    {% for category in categories %}
                                                        <option  {%  if category.assetCategories_id == asset.assetCategories_id %} selected {% endif %} value="{{ category.assetCategories_id }}">{{ category.assetCategoriesGroups_name }} - {{ category.assetCategories_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <label>Manufacturer</label>
                                            <select class="form-control  select2bs4 assetSelect2" id="manufacturer">
                                                {% for manufacturer in manufacturers %}
                                                    <option {%  if manufacturer.manufacturers_id == asset.manufacturers_id %} selected {% endif %} value="{{ manufacturer.manufacturers_id }}">{{ manufacturer.manufacturers_name }}</option>
                                                {% endfor %}
                                            </select>
                                            </form>
                                            <button class="btn btn-default float-right" id="saveSettingsButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                        </div>
                                        <div class="tab-pane" style="padding: 1.25rem" id="fields">
                                            <div class="callout callout-info">
                                                <p>Definable fields are specific attributes for assets of this type - for a lighting fixture this might be the lens fitted</p>
                                            </div>
                                            <form id="editDefinableFieldsType">
                                            {% for field in asset.fields %}
                                                <div class="input-group definableFieldsGroup" data-fieldcount="{{loop.index}}">
                                                    <div class="input-group-prepend"><span class="input-group-text">Definable Field {{loop.index}}</span></div>
                                                    <input type="text" class="definableFieldsInput form-control" name="asset_definableFields_{{ loop.index }}" value="{{field}}" data-fieldcount="{{loop.index}}" />
                                                </div>
                                            {% endfor %}
                                            </form>
                                            <div class="callout callout-danger">
                                                <p>Leave a field blank to delete it</p>
                                            </div>
                                            <button class="btn btn-default float-right" id="saveTypeDefinableFieldButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                        </div>
                                        <div class="tab-pane" style="padding: 1.25rem" id="thumbnail">
                                            {% if "ASSETS:ASSET_TYPE_FILE_ATTACHMENTS:CREATE"|instancePermissions %}
                                                {% embed 'common/plugins/uppy.twig' with {'type': 'ASSET-THUMBNAIL', 'paste': true, 'typeId': 2, 'subTypeId': asset.assetTypes_id, 'imagesOnly': true } %}
                                                    {% block success %}
                                                        console.log(responseJson.id);
                                                    {% endblock %}
                                                {% endembed %}
                                                <br/>
                                            {% endif %}
                                            {% embed 'common/plugins/fileBox.twig' with {'files': asset.thumbnail, 'galleryOnly': true } %}
                                            {% endembed %}
                                        </div>
                                    </div>
                                    <!-- /.tab-content -->
                                </div><!-- /.card-body -->
                            </div>
                        </div>
                        {% elseif "ASSETS:ASSET_TYPES:EDIT"|instancePermissions %}
                        <div class="tab-pane" style="padding: 1.25rem" id="settings">
                            <div class="alert alert-info" role="alert">
                                <h4 class="alert-heading">Asset type maintained by the AdamRMS</h4>Sorry - this asset type is shared between a number of different businesses as a pre-defined template, to edit it please <a href="{{ CONFIG.ROOTURL }}/support.php">get in touch with support</a>
                            </div>
                        </div>
                        {% endif %}

                        {% if "ASSETS:ASSET_TYPE_FILE_ATTACHMENTS:VIEW"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                        <div class="tab-pane" style="padding: 1.25rem"  id="typeFiles">
                            {% if "ASSETS:ASSET_TYPE_FILE_ATTACHMENTS:CREATE"|instancePermissions %}
                            <div class="callout callout-default">
                                Use this area to store files relevant to all assets of this type such as instruction manuals
                            </div>
                            {% embed 'common/plugins/uppy.twig' with {'type': 'ASSET-TYPE-FILE', 'paste': false, 'typeId': 3, 'subTypeId': asset.assetTypes_id, 'imagesOnly': false } %}
                                {% block success %}
                                    console.log(responseJson.id);
                                {% endblock %}
                            {% endembed %}
                            <br/>
                            {% endif %}
                            {% embed 'common/plugins/fileBox.twig' with {'files': asset.files } %}
                            {% endembed %}
                        </div>
                        {% endif %}
                        {% if "MAINTENANCE_JOBS:VIEW"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                            <div class="tab-pane" style="padding:0"  id="maintenance">
                                <div class="card" style="margin-bottom:0;">
                                    <div class="card-header p-2">
                                        <ul class="nav nav-pills">
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-newJob" data-toggle="tab">New Job</a></li>
                                            <li class="nav-item"><a class="nav-link active" href="#maintenance-flags" data-toggle="tab">Blocks &amp; Flags</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-jobsOutstanding" data-toggle="tab">Jobs Outstanding</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-jobsCompleted" data-toggle="tab">Jobs Completed</a></li>
                                        </ul>
                                    </div><!-- /.card-header -->
                                    <div class="card-body" style="padding: 0;">
                                        <div class="tab-content">
                                            <div class="tab-pane" style="padding: 1.25rem" id="maintenance-newJob">
                                                <style>
                                                    .input-group {
                                                        margin-bottom: 5px;
                                                    }
                                                </style>
                                                <form id="addNewJobForm">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Asset</span></div>
                                                        <input type="text" class="form-control" disabled value="{{ assets[0].assets_tag|aTag }}" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Title</span></div>
                                                        <input type="text" class="form-control" name="maintenanceJobs_title" id="maintenanceJobstitle" placeholder="Drum revolve key missing" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Fault Description</span></div>
                                                        <textarea class="form-control" rows="5" name="maintenanceJobs_faultDescription" id="maintenanceJobsfaultDescription" placeholder="Details of the fault"></textarea>
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                              Priority
                                                            </span>
                                                        </div>
                                                        <select class="form-control" name="maintenanceJobs_priority">
                                                            {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                <option value="{{ type.id }}" {% if type.default %} selected {% endif %}>{{ type.text }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="input-group">
                                                        <label>Tag Users</label>
                                                        <select class="form-control" multiple="multiple" placeholder="Select users to be tagged for updates in the job" id="tagUserInJob">
                                                        </select>
                                                    </div>
                                                </form>

                                                <button class="btn btn-default float-right" id="addNewJobButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            <div class="active tab-pane" style="padding: 1.25rem" id="maintenance-flags">
                                                {% for flag in assets[0].flagsblocks.BLOCK %}
                                                    <div class="alert alert-danger">
                                                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button" style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                                                        <h5><i class="fas fa-ban"></i> {{ flag.maintenanceJobs_title }}</h5>
                                                        {{ flag.maintenanceJobs_faultDescription }}
                                                    </div>
                                                {% endfor %}
                                                {% for flag in assets[0].flagsblocks.FLAG %}
                                                <div class="alert alert-warning">
                                                    <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button"  style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                                                    <h5><i class="far fa-flag"></i> {{ flag.maintenanceJobs_title }}</h5>
                                                    {{ flag.maintenanceJobs_faultDescription }}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <div class="tab-pane" style="padding: 0;" id="maintenance-jobsOutstanding">
                                                <table class="table table-striped projects">
                                                    <thead>
                                                    <tr>
                                                        <th style="width: 1%">
                                                            #
                                                        </th>
                                                        <th>
                                                            Title
                                                        </th>
                                                        <th style="width: 5%">
                                                            Creator
                                                        </th>
                                                        <th style="width: 5%">
                                                            Assigned
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Priority
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Status
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-flag"></i>
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-ban"></i>
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for job in assets[0].jobs %}
                                                        {% if job.maintenanceJobsStatuses_id != 2 %}
                                                        <tr>
                                                            <td>
                                                                <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ job.maintenanceJobs_id }}">#{{ job.maintenanceJobs_id }}</a>
                                                            </td>
                                                            <td>
                                                                <a>
                                                                    {{ job.maintenanceJobs_title }}
                                                                </a>
                                                                <br/>
                                                                <small>
                                                                    Created {{job.maintenanceJobs_timestamp_added|date("d M Y h:i:sa")}}
                                                                </small>
                                                            </td>
                                                            <td>
                                                                <ul class="list-inline">
                                                                    <li class="list-inline-item">
                                                                        <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userCreatorUserID }}" title="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 ~ " (" ~ job.userCreatorUserEMail ~ ")" }}">
                                                                            <img alt="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 }}" class="table-avatar" src="{{ job.userCreatorUserThumb ? job.userCreatorUserThumb|s3URL("small") : CONFIG.ASSETCDNURL ~ '/img/default-profile-picture.jpg' }}">
                                                                        </a>
                                                                    </li>
                                                                </ul>
                                                            </td>
                                                            <td>
                                                                {% if job.userAssignedUserName1 != null %}
                                                                    <ul class="list-inline">
                                                                        <li class="list-inline-item">
                                                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userAssignedUserID }}" title="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 ~ " (" ~ job.userAssignedUserEMail ~ ")" }}">
                                                                                <img alt="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}" class="table-avatar" src="{{ job.userAssignedUserThumb ? job.userAssignedUserThumb|s3URL("small") : CONFIG.ASSETCDNURL ~ '/img/default-profile-picture.jpg' }}">
                                                                            </a>
                                                                        </li>
                                                                    </ul>
                                                                {% endif %}
                                                            </td>
                                                            <td class="project-state">
                                                                {% if job.maintenanceJobs_priority %}
                                                                    {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                        <span class="badge badge-{{ type.class }}" value="{{ type.id }}" {% if job.maintenanceJobs_priority != type.id %} style="display: none;" {% endif %}>{{ type.text }}</span>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            </td>
                                                            <td class="project-state">
                                                                {% if job.maintenanceJobsStatuses_name %}
                                                                    <span class="badge badge-default">{{ job.maintenanceJobsStatuses_name }}</span>
                                                                {% else %}
                                                                    <span class="badge badge-default">Awaiting Sorting</span>
                                                                {% endif %}
                                                            </td>
                                                            <td >
                                                                {% if job.maintenanceJobs_flagAssets == 1 %}
                                                                    <i class="fas fa-flag"></i>
                                                                {% endif %}
                                                            </td>
                                                            <td >
                                                                {% if job.maintenanceJobs_blockAssets == 1 %}
                                                                    <i class="fas fa-ban"></i>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="tab-pane" style="padding: 0" id="maintenance-jobsCompleted">
                                                <table class="table table-striped projects">
                                                    <thead>
                                                    <tr>
                                                        <th style="width: 1%">
                                                            #
                                                        </th>
                                                        <th>
                                                            Title
                                                        </th>
                                                        <th style="width: 5%">
                                                            Creator
                                                        </th>
                                                        <th style="width: 5%">
                                                            Assigned
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Priority
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Status
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-flag"></i>
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-ban"></i>
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for job in assets[0].jobs %}
                                                        {% if job.maintenanceJobsStatuses_id == 2 %}
                                                            <tr>
                                                                <td>
                                                                    <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ job.maintenanceJobs_id }}">#{{ job.maintenanceJobs_id }}</a>
                                                                </td>
                                                                <td>
                                                                    <a>
                                                                        {{ job.maintenanceJobs_title }}
                                                                    </a>
                                                                    <br/>
                                                                    <small>
                                                                        Created {{job.maintenanceJobs_timestamp_added|date("d M Y h:i:sa")}}
                                                                    </small>
                                                                </td>
                                                                <td>
                                                                    <ul class="list-inline">
                                                                        <li class="list-inline-item">
                                                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userCreatorUserID }}" title="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 ~ " (" ~ job.userCreatorUserEMail ~ ")" }}">
                                                                                <img alt="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 }}" class="table-avatar" src="{{ job.userCreatorUserThumb ? job.userCreatorUserThumb|s3URL("small") : CONFIG.ASSETCDNURL ~ '/img/default-profile-picture.jpg' }}">
                                                                            </a>
                                                                        </li>
                                                                    </ul>
                                                                </td>
                                                                <td>
                                                                    {% if job.userAssignedUserName1 != null %}
                                                                        <ul class="list-inline">
                                                                            <li class="list-inline-item">
                                                                                <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userAssignedUserID }}" title="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 ~ " (" ~ job.userAssignedUserEMail ~ ")" }}">
                                                                                    <img alt="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}" class="table-avatar" src="{{ job.userAssignedUserThumb ? job.userAssignedUserThumb|s3URL("small") : CONFIG.ASSETCDNURL ~ '/img/default-profile-picture.jpg' }}">
                                                                                </a>
                                                                            </li>
                                                                        </ul>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobs_priority %}
                                                                        {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                            <span class="badge badge-{{ type.class }}" value="{{ type.id }}" {% if job.maintenanceJobs_priority != type.id %} style="display: none;" {% endif %}>{{ type.text }}</span>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobsStatuses_name %}
                                                                        <span class="badge badge-default">{{ job.maintenanceJobsStatuses_name }}</span>
                                                                    {% else %}
                                                                        <span class="badge badge-default">Awaiting Sorting</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_flagAssets == 1 %}
                                                                        <i class="fas fa-flag"></i>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_blockAssets == 1 %}
                                                                        <i class="fas fa-ban"></i>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- /.tab-content -->
                                    </div><!-- /.card-body -->
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <!-- /.tab-content -->
                </div><!-- /.card-body -->
            </div>
        </div>
    </div>



        <script>
            $(document).ready(function () {
                $(".assetSelect2").select2({
                    theme: "bootstrap4",
                    width: '100%'
                });
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                $('.slick').slick({
                    dots: true,
                    arrows: false,
                    pauseOnHover: true,
                    draggable: false,
                    infinite: true,
                    slidesToShow: 1,
                    slidesToScroll: 1,
                    autoplay: true,
                    autoplaySpeed: 5000,
                    fade: true,
                    cssEase: 'linear'
                });
                {% if "ASSETS:DELETE"|instancePermissions %}
                $(".deleteAssetButton").click(function () {
                    var assetid = $(this).data("assetid");
                    bootbox.confirm({
                        message: "Are you sure you wish to delete this asset?",
                        buttons: {
                            confirm: {
                                label: 'Yes',
                                className: 'btn-danger'
                            },
                            cancel: {
                                label: 'No',
                                className: 'btn-success'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajaxcall("assets/delete.php", {"assets_id":assetid}, function (data) {
                                    window.location.href = "{{CONFIG.ROOTURL}}/";
                                });
                            }
                        }
                    });
                });
                {% endif %}
                {% if "ASSETS:ARCHIVE"|instancePermissions %}
                $(".archiveAssetButton").click(function () {
                    var assetid = $(this).data("assetid");
                    var date;
                    bootbox.prompt({
                        title: "When would you like the asset to be archived?",
                        inputType: 'date',
                        callback: function (result) {
                            if (result) {
                                date = result;
                                bootbox.prompt({
                                    title: "Why is this asset being archived?",
                                    inputType: 'select',
                                    inputOptions: [
                                        {
                                            text: 'Being Sold',
                                            value: 'sold',
                                        },
                                        {
                                            text: 'End of Life - being destroyed',
                                            value: 'destroyed',
                                        },
                                        {
                                            text: 'Missing/Lost',
                                            value: 'lost',
                                        },
                                        {
                                            text: 'Permanent Loan',
                                            value: 'loaned permanently',
                                        }
                                    ],
                                    callback: function (result) {
                                        if (result) {
                                            ajaxcall("assets/archive.php", {"assets_id":assetid, "date":date,"reason":result}, function (data) {
                                                location.reload();
                                            });
                                        }
                                    }
                                });
                            }
                        }
                    });
                });
                {% endif %}
                {% if "ASSETS:ASSET_BARCODES:DELETE"|instancePermissions %}
                $(".deleteBarcodeButton").click(function () {
                    var barcodeid = $(this).data("barcodeid");
                    bootbox.confirm({
                        message: "Are you sure you wish to delete this barcode?",
                        buttons: {
                            confirm: {
                                label: 'Yes',
                                className: 'btn-danger'
                            },
                            cancel: {
                                label: 'No',
                                className: 'btn-success'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajaxcall("assets/barcodes/delete.php", {"barcodes_id":barcodeid}, function (data) {

                                    location.reload();
                                });
                            }
                        }
                    });
                });
                {% endif %}
                {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions %}
                $("#addNewType-value").change(function() {
                    $("#addNewType-dayRate-guide").html("2% = &pound;" + ($(this).val()*0.02).toFixed(2));
                    $("#addNewType-weekRate-guide").html("6% = &pound;" + ($(this).val()*0.06).toFixed(2));
                });
                $('#saveSettingsButton').on('click', function() {
                    var formData = $("#addNewForm").serializeArray();
                    formData.push({"name": "manufacturers_id", "value":$('#manufacturer').val()}, {"name": "assetTypes_id", "value": "{{asset.assetTypes_id}}"});
                    console.log(formData);
                    ajaxcall("assets/editAssetType.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                $('#saveTypeDefinableFieldButton').on('click', function() {
                    var formData = $("#editDefinableFieldsType").serializeArray();
                    formData.push({"name": "assetTypes_id", "value": "{{asset.assetTypes_id}}"});
                    ajaxcall("assets/editAssetTypeDefinableFields.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                {% endif %}
                {% if "ASSETS:EDIT"|instancePermissions %}
                $('#saveAssetSettingsButton').on('click', function() {
                    var formData = $("#editAssetDetailsForm").serializeArray();
                    formData.push({"name": "assets_id", "value": "{{assets[0]['assets_id']}}"});
                    ajaxcall("assets/editAsset.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                $('#saveAssetDefinableFieldButton').on('click', function() {
                    var formData = $("#editAssetDefinableFieldsForm").serializeArray();
                    formData.push({"name": "assets_id", "value": "{{assets[0]['assets_id']}}"});
                    ajaxcall("assets/editAsset.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                {% if "ASSETS:EDIT:OVVERRIDES"|instancePermissions %}
                $('#editAssetDetailsOverridesButton').on('click', function() {
                    var formData = $("#editAssetDetailsOverridesForm").serializeArray();
                    formData.push({"name": "assets_id", "value": "{{assets[0]['assets_id']}}"});
                    ajaxcall("assets/editAsset.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                {% endif %}
                $("#assetTypeChange").select2({
                    tags: false,
                    multiple: false,
                    theme: "bootstrap4",
                    minimumInputLength: 1,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Search for asset types",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/assets/searchType.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        return {
                                            text: item.manufacturers_name + " - " + item.assetTypes_name,
                                            id: item.assetTypes_id
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                });
                $('#saveAssetTypeChangeButton').on('click', function() {
                    if ($("#assetTypeChange").val()) {
                        var formData = [
                            {
                                "name" : "assets_id",
                                "value" : "{{ assets[0]['assets_id'] }}"
                            },
                            {
                                "name" : "assetTypes_id",
                                "value" : $("#assetTypeChange").val()
                            },
                        ];
                        ajaxcall("assets/editAsset.php", {formData}, function (data) {
                            window.location.href = "{{ CONFIG.ROOTURL }}/asset.php?instance={{ASSET_INSTANCE.instances_id}}&id=" + $("#assetTypeChange").val();
                        }, false);
                    }
                });

                $("#assetLinkChange").select2({
                    tags: false,
                    multiple: false,
                    theme: "bootstrap4",
                    minimumInputLength: 1,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Search for assets",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/assets/searchAssets.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        if (item.assets_id != '{{ assets[0]['assets_id'] }}') {
                                            return {
                                                text: item['tag'] + " | " + item.assetTypes_name,
                                                id: item['assets_id']
                                            }
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                });
                $('#saveAssetLinkChangeButton').on('click', function() {
                    if ($("#assetLinkChange").val()) {
                        var formData = [
                            {
                                "name" : "assets_id",
                                "value" : "{{ assets[0]['assets_id'] }}"
                            },
                            {
                                "name" : "assets_linkedTo",
                                "value" : $("#assetLinkChange").val()
                            },
                        ];
                        ajaxcall("assets/editAsset.php", {formData}, function (data) {
                            location.reload();
                        }, false);
                    }
                });
                $('#removeAssetLinkChangeButton').on('click', function() {
                    var formData = [
                        {
                            "name" : "assets_id",
                            "value" : "{{ assets[0]['assets_id'] }}"
                        },
                        {
                            "name" : "assets_linkedTo",
                            "value" : ""
                        },
                    ];
                    ajaxcall("assets/editAsset.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                {% endif %}

                $("#assetGroups").select2({
                    tags: false,
                    multiple: true,
                    theme: "bootstrap4",
                    {% if "ASSETS:ASSET_GROUPS:EDIT:ASSETS_WITHIN_GROUP"|instancePermissions != true %}
                    disabled: true,
                    {% endif %}
                    minimumInputLength: 1,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Enter group name to search",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/groups/search.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        return {
                                            text: item.assetGroups_name,
                                            id: item.assetGroups_id
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                });
                {% if "ASSETS:ASSET_GROUPS:EDIT:ASSETS_WITHIN_GROUP"|instancePermissions %}
                $('#assetGroups').on('select2:select', function (e) {
                    var id =e.params.data.id;
                    ajaxcall("groups/addAsset.php", {
                        "assetGroups_id": id,
                        "assets_id": "{{ assets[0]['assets_id'] }}"
                    });
                });
                $('#assetGroups').on('select2:unselect', function (e) {
                    var id =e.params.data.id;
                    ajaxcall("groups/removeAsset.php", {
                        "assetGroups_id": id,
                        "assets_id": "{{ assets[0]['assets_id'] }}"
                    });
                });
                {% endif %}
                {% if "MAINTENANCE_JOBS:VIEW"|instancePermissions %}
                $("#tagUserInJob").select2({
                    tags: false,
                    multiple: true,
                    theme: "bootstrap4",
                    minimumInputLength: 1,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Enter name to search for users",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/maintenance/searchUser.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        return {
                                            text: item.users_name1 + " " + item.users_name2,
                                            id: item.users_userid
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                });
                $('#addNewJobButton').on('click', function() {
                    var formData = $("#addNewJobForm").serializeArray();
                    if ($("#maintenanceJobstitle").val().length > 0 && $("#maintenanceJobsfaultDescription").val().length > 0) {
                        formData.push({"name": "maintenanceJobs_assets", "value": "{{assets[0]['assets_id']}}"},{"name": "maintenanceJobs_user_tagged", "value": $("#tagUserInJob").val()},{"name": "maintenanceJobs_user_creator", "value": "{{ USERDATA.users_userid }}"});
                        ajaxcall("maintenance/newJob.php", {formData}, function (data) {
                            window.location.href = "{{ CONFIG.ROOTURL }}/maintenance/job.php?id=" + data.response['maintenanceJobs_id'];
                        }, false);
                    }
                });
                {% endif %}
                {% if "ASSETS:TRANSFER"|instancePermissions %}
                $("#assetMigrateInstance").select2({
                    tags: false,
                    multiple: false,
                    theme: "bootstrap4",
                    minimumInputLength: 0,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Search for a Business",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/instances/list.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        if (item.permissions.includes("ASSETS:TRANSFER")) {
                                            return {
                                                text: item.instances_name,
                                                id: item.instances_id
                                            }
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                })

                $("#assetMigrateInstance").on('select2:select', function () {
                    var id = $(this).select2('data')[0].id;
                    $('#assetMigrateAssetType').parent().show();
                    try {
                        // destroy select2 if already initialized
                        $('#assetMigrateAssetType').select2('destroy');
                    } catch (e) {} // ignore
                    $('#assetMigrateAssetType').empty();
                    $('#assetMigrateAssetType').select2({
                        tags: false,
                        multiple: false,
                        theme: "bootstrap4",
                        minimumInputLength: 0,
                        width: '100%',
                        minimumResultsForSearch: 1,
                        placeholder: "Search for an Asset Type",
                        ajax: {
                            url: "{{ CONFIG.ROOTURL }}/api/assets/searchType.php?other_instances_id=" + id,
                            dataType: "json",
                            type: "POST",
                            data: function (params) {
                                var queryParameters = {
                                    term: params.term
                                }
                                return queryParameters;
                            },
                            processResults: function (data) {
                                if (data && data.result && data.response) {
                                    const responseData = $.map(data.response, function (item) {
                                            return {
                                                text: item.manufacturers_name + " - " + item.assetTypes_name,
                                                id: item.assetTypes_id
                                            }
                                        });
                                    return {
                                        // add "Other" to the end of the list
                                        results: [...responseData, {
                                            text: "Copy the existing asset type ({{asset.assetTypes_name}}) into business",
                                            id: "-1"
                                        }]
                                    };
                                } else return {
                                    results: [{
                                            text: "Copy the existing asset type ({{asset.assetTypes_name}}) into business",
                                            id: "-1"
                                        }]
                                };
                            }
                        }
                    })
                });
                $("#assetMigrateAssetType").on('select2:select', function () {
                    const id = $(this).select2('data')[0].id;
                    const instanceId = $("#assetMigrateInstance").select2('data')[0].id;
                    //Reset selectboxes
                    try {
                        // destroy select2 if already initialized
                        $('#assetMigrateManufacturer, #assetMigrateCategory').select2('destroy');
                    } catch (e) {} // ignore
                    $('#assetMigrateManufacturer, #assetMigrateCategory').empty();

                    if (id == "-1") {
                        $('#assetMigrateManufacturer').parent().show();
                        $('#assetMigrateCategory').parent().show();
                        $('#assetMigrateManufacturer').select2({
                            tags: false,
                            multiple: false,
                            theme: "bootstrap4",
                            minimumInputLength: 0,
                            width: '100%',
                            minimumResultsForSearch: 1,
                            placeholder: "Search for a Manufacturer",
                            ajax: {
                                url: "{{ CONFIG.ROOTURL }}/api/manufacturer/search.php?other_instances_id=" + instanceId,
                                dataType: "json",
                                type: "POST",
                                data: function (params) {
                                    var queryParameters = {
                                        term: params.term
                                    }
                                    return queryParameters;
                                },
                                processResults: function (data) {
                                    if (data && data.result && data.response) {
                                        const responseData = $.map(data.response, function (item) {
                                                return {
                                                    text: item.manufacturers_name,
                                                    id: item.manufacturers_id
                                                }
                                            })
                                        return {
                                        // add "Other" to the end of the list
                                        results: [...responseData,{
                                            text: "Copy {{ asset.manufacturers_name }} into business",
                                            id: "-1"
                                        }]
                                    };
                                    } else return {
                                        results: [{
                                            text: "Copy {{ asset.manufacturers_name }} into business",
                                            id: "-1"
                                        }]
                                    };
                                }
                            }
                        });
                        $('#assetMigrateCategory').select2({
                            tags: false,
                            multiple: false,
                            theme: "bootstrap4",
                            minimumInputLength: 0,
                            width: '100%',
                            minimumResultsForSearch: 1,
                            placeholder: "Search for a Category",
                            ajax: {
                                url: "{{ CONFIG.ROOTURL }}/api/categories/search.php?other_instances_id=" + instanceId,
                                dataType: "json",
                                type: "POST",
                                data: function (params) {
                                    var queryParameters = {
                                        term: params.term
                                    }
                                    return queryParameters;
                                },
                                processResults: function (data) {
                                    if (data && data.result && data.response) {
                                        return {
                                            results: $.map(data.response, function (item) {
                                                return {
                                                    text: item.assetCategoriesGroups_name + " - " + item.assetCategories_name,
                                                    id: item.assetCategories_id
                                                }
                                            })
                                        };
                                    } else return {
                                        results: []
                                    };
                                }
                            }
                        })
                    } else {
                        $('#assetMigrateManufacturer').parent().hide();
                        $('#assetMigrateCategory').parent().hide();
                    }
                });

                $("#assetMigrate").on("click", function () {
                    const newInstanceId = $("#assetMigrateInstance").select2('data')[0].id;
                    const newAssetTypeId = $("#assetMigrateAssetType").select2('data')[0].id;
                    let newManufacturerId = -1;
                    let newCategoryId = -1;
                    try {
                        newManufacturerId = $("#assetMigrateManufacturer").select2('data')[0].id;
                        newCategoryId = $("#assetMigrateCategory").select2('data')[0].id;
                    } catch (e) { } //ignore
                    const assetId = {{ assets[0]['assets_id'] }};
                    
                    let args = {}
                    if (newAssetTypeId == "-1") {
                        args = {
                            "assets_id": assetId,
                            "new_instances_id": newInstanceId,
                            "newAssetType": false,
                            "manufacturers_id": (newManufacturerId == -1 ? false : newManufacturerId), //can be "Copied from Asset"
                            "assetCategories_id": newCategoryId,
                        }
                    } else {
                        args = {
                            "assets_id": assetId,
                            "new_instances_id": newInstanceId,
                            "assetTypes_id": newAssetTypeId,
                        }
                    }
                    bootbox.confirm({
                        message: "Are you sure you wish to transfer this asset?",
                        buttons: {
                            confirm: {
                                label: 'Yes',
                                className: 'btn-danger'
                            },
                            cancel: {
                                label: 'No',
                                className: 'btn-success'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajaxcall("assets/transfer.php", 
                                    args,
                                    function (data) {
                                        location.href = "{{ CONFIG.ROOTURL }}/assets.php";
                                    }
                                );
                            }
                        }
                    });
                });
                {% endif %}
            });
        </script>
        {% embed 'common/plugins/fileBoxJS.twig' %}
        {% endembed %}
{% endblock %}
