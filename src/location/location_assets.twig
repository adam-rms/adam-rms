{% extends "assets/template.twig" %}
{% block additionalImports %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js" integrity="sha512-BkpSL20WETFylMrcirBahHfSnY++H2O1W+UnEEO4yNIl+jI2+zowyoGJpbtk6bx97fBXf++WJHSSK2MV4ghPcg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/dataTables.bootstrap4.min.js" integrity="sha512-OQlawZneA7zzfI6B1n1tjUuo3C5mtYuAWpQdg+iI9mkDoo7iFzTqnQHf+K5ThOWNJ9AbXL4+ZDwH7ykySPQc+A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/dataTables.bootstrap4.min.css" integrity="sha512-PT0RvABaDhDQugEbpNMwgYBCnGCiTZMh9yOzUsJHDgl/dMhD9yjHAwoumnUk3JydV3QTcIkNDuN40CJxik5+WQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}
{% block content %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-box"></i>
                    {{ assetCount }} Asset{{ assetCount != 1 ? 's' : '' }} at {{ location.locations_name }}
                </h3>
                <div class="card-tools">
                    <a href="{{ CONFIG.ROOTURL }}/location/" class="btn btn-sm btn-default">
                        <i class="fas fa-arrow-left"></i> Back to Locations
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if location.locations_address %}
                    <p><strong>Address:</strong> {{ location.locations_address|nl2br }}</p>
                {% endif %}
                {% if location.clients_name %}
                    <p><strong>Client:</strong> {{ location.clients_name }}</p>
                {% endif %}
            </div>
        </div>

        {% if assets|length > 0 %}
            <div class="card">
                <div class="card-body table-responsive p-0">
                    <table id="locationAssetsTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Tag</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Manufacturer</th>
                                <th>Current Project</th>
                                <th>Status</th>
                                <th>Last Scanned</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in assets %}
                                <tr>
                                    <td><strong>{{ asset.assets_tag }}</strong></td>
                                    <td>{{ asset.assetTypes_name }}</td>
                                    <td>{{ asset.assetCategoriesGroups_name }} - {{ asset.assetCategories_name }}</td>
                                    <td>{{ asset.manufacturers_name }}</td>
                                    <td>
                                        {% if asset.currentAssignment %}
                                            <a href="{{ CONFIG.ROOTURL }}/project/?id={{ asset.currentAssignment.projects_id }}">
                                                {{ asset.currentAssignment.projects_name }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">Not assigned</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if asset.currentAssignment and asset.currentAssignment.assetsAssignmentsStatus_name %}
                                            <span class="badge badge-info">
                                                {{ asset.currentAssignment.assetsAssignmentsStatus_name }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td data-order="{{ asset.latestScan ? asset.latestScan.assetsBarcodesScans_timestamp : '0' }}">
                                        {% if asset.latestScan %}
                                            {{ asset.latestScan.assetsBarcodesScans_timestamp|date("d M Y H:i") }}
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">
                                        <a href="{{ CONFIG.ROOTURL }}/asset.php?id={{ asset.assetTypes_id }}&asset={{ asset.assets_id }}"
                                           class="btn btn-sm btn-default">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="card-body">
                    <p class="text-muted">No assets currently stored at this location.</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
$(document).ready(function() {
    $('#locationAssetsTable').DataTable({
        "paging": true,
        "lengthChange": true,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
        "pageLength": 25,
        "order": [[6, "desc"]], // Sort by Last Scanned (column index 6) descending by default
        "columnDefs": [
            { "orderable": false, "targets": 7 } // Disable sorting on the last column (View button)
        ]
    });
});
</script>

{% endblock %}