{% extends "assets/template.twig" %}
{% block htmlIncludes %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/8.19.1/sweetalert2.min.js" integrity="sha512-wKdazFGbrow0TxFpymoSlXoqpHt9SOXw94CYLZV+BTCbk6RH67FuaVTjMo2/rs0doYWEy8mdGbk0/mSSUOJG7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet"  href="{{ CONFIG.ROOTURL }}/static-assets/libs/sweetalert2/sweetAlert2-bootstrap-4.min.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.5/main.min.css" integrity="sha512-1P/SRFqI1do4eNtBsGIAqIZIlnmOQkaY7ESI2vkl+q+hl9HSXmdPqotN0McmeZVyR4AWV+NvkP6pKOiVdY/V5A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.11.5/main.min.js" integrity="sha512-VyGX7HXwa9yMgIfDPYcj7+XFjtSEzqY7LTf2Tvn2FAf4O6MkD5UzNkrlkMHyLQMbdYfor8SNYKyyeBhTazNgPw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" integrity="sha512-yHknP1/AwR+yx26cB1y0cjvQUMvEa2PFzt1c9LlS4pRQ5NOTZFWbhBig+X9G9eYW/8m0/4OXNx8pxJ6z57x0dw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css" integrity="sha512-17EgCFERpgZKcm0j0fEq1YCJuyAWdz9KUtv1EjVuaOz8pDnh/0nZxmU6BBXwaaxqoi9PQXnRWqlcDB027hgv9A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-migrate/1.2.1/jquery-migrate.min.js" integrity="sha512-fDGBclS3HUysEBIKooKWFDEWWORoA20n60OwY7OSYgxGEew9s7NgDaPkj7gqQcVXnASPvZAiFW8DiytstdlGtQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js" integrity="sha512-XtmMtDEcNz2j7ekrtHvOVR4iwwaD6o/FUJe6+Zq+HgcCsk3kj4uSQQR8weQ2QVj1o0Pk6PwYLohm206ZzNfubg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-md-3">
            {% if assets|length == 1 %}
                <div class="card card-secondary card-outline">
                    <div class="card-body box-profile">
                        <h3 class="profile-username text-center">{{ assets[0].assets_tag|aTag }}</h3>
                        {% if assets[0].assets_endDate is not null and assets[0].assets_endDate|date("U") <= "now"|date("U")  %}
                            <div class="alert alert-danger">
                                <h5> <i class="fas fa-archive"></i> Asset Archived</h5>
                                Asset was {{ assets[0].assets_archived }} on {{ assets[0].assets_endDate|date("d/M/Y") }}
                            </div>
                        {% endif %}
                        {% if assets[0]['link'] %}
                            <div class="callout callout-success">
                                Asset is linked to asset <a href="{{ CONFIG.ROOTURL }}/asset.php?id={{ assets[0]['link']['assetTypes_id'] }}&instance={{ASSET_INSTANCE.instances_id}}&asset={{ assets[0]['link']['assets_id'] }}">{{ assets[0]['link']['assets_tag']|aTag }} ({{ assets[0]['link']['assetTypes_name'] }})</a>
                            </div>
                        {% endif %}
                        {% if assets[0]['assets_notes']|length > 0 %}
                            <p>{{ assets[0]['assets_notes']|nl2br }}</p>
                        {% endif %}
                        <ul class="list-group list-group-unbordered mb-3">
                            {% set assetFieldsLength = 0 %}
                            {% for field in asset.fields %}
                                {% if field != "" %}
                                    {% set assetFieldsLength = assetFieldsLength +1 %}{# Build a count of the number of fields use to help editing an asset #}
                                    <li class="list-group-item">
                                        <b>{{field}}</b> <span class="float-right text-primary">{{ assets[0]['asset_definableFields_' ~ loop.index] }}</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            <li class="list-group-item">
                                <b>Mass</b> <span class="float-right text-primary">{{ (assets[0]['assets_mass'] ? assets[0]['assets_mass']|mass : (asset.assetTypes_mass != "" and asset.assetTypes_mass != 0 ? asset.assetTypes_mass|mass : '?')) }}</span>
                            </li>
                            <li class="list-group-item">
                                <b>Value</b> <span class="float-right text-primary">{{ (assets[0]['assets_value'] ?: asset.assetTypes_value)|money(ASSET_INSTANCE['instances_config_currency']) }}</span>
                            </li>
                            <li class="list-group-item">
                                <b>Day Rate</b> <span class="float-right text-primary">{{ (assets[0]['assets_dayRate'] ?: asset.assetTypes_dayRate)|money(ASSET_INSTANCE['instances_config_currency']) }}</span>
                            </li>
                            <li class="list-group-item">
                                <b>Week Rate</b> <span class="float-right text-primary">{{ (assets[0]['assets_weekRate'] ?: asset.assetTypes_weekRate)|money(ASSET_INSTANCE['instances_config_currency']) }}</span>
                            </li>
                            {% if assets[0]['storage_location'] %}
                            <li class="list-group-item">
                                <b>Storage Location</b>
                                {% if "LOCATIONS:VIEW"|instancePermissions %}
                                    <a class="float-right" href="{{ CONFIG.ROOTURL }}/location/">{{assets[0]['storage_location'][0]['locations_name']}}</a>
                                {% else %}
                                    <span class="float-right">{{assets[0]['storage_location'][0]['locations_name']}}</span
                                {% endif %}
                            </li>
                            {% endif %}
                        </ul>
                        {% if "ASSETS:ARCHIVE"|instancePermissions and (assets[0].assets_endDate is null or assets[0].assets_endDate|date("U") > "now"|date("U"))  and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                        <button class="btn btn-warning btn-block archiveAssetButton" data-assetid="{{ assets[0]['assets_id'] }}" style="margin-bottom: 10px;">Archive</button>
                        {% endif %}
                        {% if "ASSETS:DELETE"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                        <button class="btn btn-danger btn-block deleteAssetButton" data-assetid="{{ assets[0]['assets_id'] }}" style="margin-bottom: 10px;">Delete</button>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            <div class="card card-info card-outline">
                <div class="card-body box-profile">
                    {% if CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and asset.thumbnail %}
                    <div class="text-center {{ asset.thumbnail|length > 1 ? 'slick' : '' }}">
                        {% for thumb in asset.thumbnail %}
                            <div>
                                <img class="img-fluid" style="max-height: 340px;"
                                     src="{{ thumb.s3files_id|s3URL("small") }}"
                                     alt="{{asset.assetTypes_name}}"
                                     loading="lazy">
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <h3 class="profile-username text-center">{{asset.assetTypes_name}}</h3>
                    <p>{{asset.assetTypes_description|nl2br}}</p>
                    <ul class="list-group list-group-unbordered mb-3">
                        {% if asset.assetTypes_productLink != null %}
                        <li class="list-group-item">
                            <b>Product Web Link</b> <a class="float-right" href="{{ asset.assetTypes_productLink }}" target="_blank">{{ asset.assetTypes_productLink|length > 25 ? asset.assetTypes_productLink|slice(0, 25) ~ '...': asset.assetTypes_productLink  }}</a>
                        </li>
                        {% endif %}
                        <li class="list-group-item">
                            <b>Category</b> {{ asset.assetCategoriesGroups_name }} - {{ asset.assetCategories_name }}
                        </li>
                        <li class="list-group-item">
                            <b>Manufacturer</b> {{ asset.manufacturers_name }}
                        </li>
                        <li class="list-group-item">
                            <b>Mass</b> <span class="float-right text-primary">{{asset.assetTypes_mass != "" and asset.assetTypes_mass != 0 ? asset.assetTypes_mass|mass : "?" }}</span>
                        </li>
                        <li class="list-group-item">
                            <b>Value</b> <span class="float-right text-primary">{{ asset.assetTypes_value|money(ASSET_INSTANCE['instances_config_currency']) }}</span>
                        </li>
                        <li class="list-group-item">
                            <b>Day Rate</b> <span class="float-right text-primary">{{ asset.assetTypes_dayRate|money(ASSET_INSTANCE['instances_config_currency']) }}</span>
                        </li>
                        <li class="list-group-item">
                            <b>Week Rate</b> <span class="float-right text-primary">{{ asset.assetTypes_weekRate|money(ASSET_INSTANCE['instances_config_currency']) }}</span>
                        </li>
                    </ul>
                    {% if asset.oneasset %}
                        <a href="?id={{asset.assetTypes_id}}" class="btn btn-info btn-block"><b>View All</b></a>
                    {% endif %}
                    
                </div>
            </div>
        </div>


        <div class="col-md-9">
            {% if ASSET_INSTANCE.instances_id != USERDATA.instance.instances_id %}
                <div class="alert alert-info">
                    <h5>Showing assets from business {{ ASSET_INSTANCE.instances_name }}</h5>
                </div>
            {% endif %}
            {% if assets|length == 1 %}
                {% for flag in assets[0].flagsblocks.BLOCK %}
                    <div class="alert alert-danger">
                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button" style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                        <h5> <i class="fas fa-ban"></i> {{ flag.maintenanceJobs_title }}</h5>
                        {{ flag.maintenanceJobs_faultDescription }}
                    </div>
                {% endfor %}
                {% for flag in assets[0].flagsblocks.FLAG %}
                    <div class="alert alert-warning">
                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button"  style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                        <h5><i class="far fa-flag"></i> {{ flag.maintenanceJobs_title }}</h5>
                        {{ flag.maintenanceJobs_faultDescription }}
                    </div>
                {% endfor %}
                {% if assets[0]['linkedToThis'] %}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Assets linked to this asset</h3>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for asset in assets[0]['linkedToThis'] %}
                                <tr>
                                    <td><a href="{{ CONFIG.ROOTURL }}/asset.php?id={{ asset['assetTypes_id'] }}&instance={{ASSET_INSTANCE.instances_id}}&asset={{ asset['assets_id'] }}">{{ asset['assets_tag']|aTag }}</a></td>
                                    <td>
                                        {% for i in range(1, asset['tier']) %}
                                            {% if i == 1 %}
                                            {% elseif loop.last %}
                                            &#8627;
                                            {% else %}
                                            &nbsp;
                                            {% endif %}
                                        {% endfor %}
                                        {{ asset['assetTypes_name'] }}</a>
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
            {% if assets|length == 1 and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
            <div class="card card-secondary card-outline">
                <div class="card-header p-2">
                    <ul class="nav nav-pills">
                        <li class="nav-item"><a class="nav-link active" href="#calendarBoxAsset" data-toggle="tab"><i class="far fa-calendar-alt"></i></a></li>
                        {% if "ASSETS:EDIT"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#editAsset" data-toggle="tab">Edit {{ assets[0].assets_tag|aTag }}</a></li>{% endif %}
                        {% if CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and "ASSETS:ASSET_FILE_ATTACHMENTS:VIEW"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#files" data-toggle="tab">Asset Files</a></li>{% endif %}
                        <li class="nav-item"><a class="nav-link" href="#location" data-toggle="tab">Location</a></li>
                        {% if "ASSETS:ASSET_BARCODES:VIEW"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#barcodes" data-toggle="tab">Barcodes</a></li>{% endif %}
                        {% if  "MAINTENANCE_JOBS:VIEW"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#maintenance" data-toggle="tab">Maintenance</a></li>{% endif %}
                    </ul>
                </div><!-- /.card-header -->
                <div class="card-body" style="padding: 0;">
                    <div class="tab-content">
                        <div class="active tab-pane" style="padding: 1.25rem" id="calendarBoxAsset">
                            <div id="calendar"></div>
                            <script>
                                $(function () {
                                    /* initialize the calendar
                                     -----------------------------------------------------------------*/
                                    var Calendar = FullCalendar.Calendar;

                                    var calendarEl = document.getElementById('calendar');

                                    // initialize the external events
                                    // -----------------------------------------------------------------

                                    var calendar = new Calendar(calendarEl, {
                                        themeSystem: 'bootstrap',
                                        buttonText:  {
                                            today:    'Today',
                                            month:    'Month',
                                            week:     'Week',
                                            day:      'Day',
                                            list:     'List'
                                        },
                                        headerToolbar : {
                                            left  : 'prev,next today',
                                            center: 'title',
                                            right : 'dayGridMonth,timeGridWeek'
                                        },
                                        //Random default events
                                        events    : [
                                            {% set earliestStart = false %}
                                            {% set latestEnd = false %}
                                            {% for thisasset in assets %}
                                            {% for assignment in thisasset.assignments %}
                                            {
                                                title          : '{{ thisasset.assets_tag|aTag }}{% if USERDATA['instance']['calendarSettings'].showProjectStatus %} [{{ assignment.projectsStatuses_name|escape("js") }}]{% endif %} {{ assignment.projects_name }}',
                                                start          : Date.parse("{{ assignment.projects_dates_deliver_start|date("c") }}"),
                                                end            : Date.parse("{{ assignment.projects_dates_deliver_end|date("c") }}"),
                                                url            : '{{CONFIG.ROOTURL}}/project/?id={{ assignment.projects_id }}',
                                                backgroundColor: '{{ assignment.projectsStatuses_backgroundColour }}',
                                                textColor    : '{{ assignment.projectsStatuses_foregroundColour }}'
                                            },
                                            {% if earliestStart > assignment.projects_dates_deliver_start|date("c") or earliestStart == false %}
                                            {% set earliestStart = assignment.projects_dates_deliver_start|date("c") %}
                                            {% endif %}
                                            {% if latestEnd < assignment.projects_dates_deliver_end|date("c") or latestEnd == false %}
                                            {% set latestEnd = assignment.projects_dates_deliver_end|date("c") %}
                                            {% endif %}
                                            {% endfor %}
                                            {% endfor %}
                                        ],
                                        validRange: {
                                            start: '{{ earliestStart|date("c") }}',
                                            end: '{{ latestEnd|date("c") }}'
                                        },
                                        editable  : false,
                                        droppable : false, // this allows things to be dropped onto the calendar !!!
                                        height: 600,
                                        firstDay: 1
                                    });

                                    calendar.render();
                                })
                            </script>
                        </div>
                        {% if "ASSETS:EDIT"|instancePermissions %}
                            <div class="tab-pane" style="padding:0"  id="editAsset">
                                <div class="card" style="margin-bottom:0;">
                                    <div class="card-header p-2">
                                        <ul class="nav nav-pills">
                                            <li class="nav-item"><a class="nav-link active" href="#editAssetDetails" data-toggle="tab">Details</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#linked" data-toggle="tab">Asset Link</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#groups" data-toggle="tab">Groups</a></li>
                                            {% if assetFieldsLength > 0 %}<li class="nav-item"><a class="nav-link" href="#editAssetFields" data-toggle="tab">Custom Fields</a></li>{% endif %}
                                            {% if "ASSETS:EDIT:OVVERRIDES"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#editAssetDetailsOverrides" data-toggle="tab">Asset Type Overrides</a></li>{% endif %}
                                            <li class="nav-item"><a class="nav-link" href="#editAssetType" data-toggle="tab">Change Type</a></li>
                                            {% if "ASSETS:TRANSFER"|instancePermissions and assets[0].assets_endDate is null %}<li class="nav-item"><a class="nav-link" href="#moveAsset" data-toggle="tab">Transfer Asset</a></li>{% endif %}
                                        </ul>
                                    </div><!-- /.card-header -->
                                    <div class="card-body" style="padding: 0;">
                                        <div class="tab-content">
                                            <div class="active tab-pane" style="padding: 1.25rem" id="editAssetDetails">
                                                <form id="editAssetDetailsForm">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Asset ID</span></div>
                                                        <input class="form-control" name="assets_tag" value="{{ assets[0]['assets_tag'] }}" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Asset Notes</span></div>
                                                        <textarea class="form-control" rows="2" name="assets_notes" placeholder="">{{ assets[0]['assets_notes'] }}</textarea>
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">Storage Location</span>
                                                        </div>
                                                        <select class="form-control select2bs4" name="assets_storageLocation" id="editAssetStoredLocation">
                                                            {% if assets[0]['storage_location'] == [] %}
                                                                <option value="" disabled selected>No Location Selected....</option>
                                                            {% endif %}
                                                            {% for location in locations %}
                                                                <option value="{{ location.locations_id }}" {{ assets[0]['storage_location'][0]['locations_id'] == location.locations_id ? 'selected' }} {{ location.locations_archived == 1 ? 'disabled' }}>{{ location.locations_archived == 1 ? '[Archived] ' }}{{ location.locations_name }}</option>
                                                                {% for subLocation in location.linkedToThis %}
                                                                    <option value="{{ subLocation.locations_id }}" {{ assets[0]['storage_location'][0]['locations_id'] == subLocation.locations_id ? 'selected' }}  {{ subLocation.locations_archived == 1 ? 'disabled' }} title="{% for i in range(1, subLocation['tier']) %}{% if loop.last %}&#8627;{% else %}&nbsp;&nbsp;{% endif %}{% endfor %}">
                                                                        {{ subLocation.locations_archived == 1 ? '[Archived] ' }}{{ subLocation.locations_name }}
                                                                    </option>
                                                                {% endfor %}
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </form>
                                                <button class="btn btn-default float-right" id="saveAssetSettingsButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            <div class="tab-pane" style="padding: 1.25rem" id="linked">
                                                <div class="callout">
                                                    Linking this asset to another means that whenever that asset is added to a project this asset is also added. For example, you might link an assets power supply to the asset
                                                </div>
                                                {% if USERDATA.instance.instances_config_linkedDefaultDiscount > 0 %}
                                                    <div class="callout callout-danger">
                                                        When linked assets are added to a project they are discounted by {{ USERDATA.instance.instances_config_linkedDefaultDiscount }}% by default
                                                    </div>
                                                {% endif %}
                                                <select class="form-control select2bs4 assetSelect2" id="assetLinkChange">
                                                    {% if assets[0]['assets_linkedTo'] %}
                                                        <option value="{{ assets[0]['assets_linkedTo'] }}" selected>{{ assets[0]['link']['assets_tag']|aTag }} ({{ assets[0]['link']['assetTypes_name'] }})</option>
                                                    {% endif %}
                                                </select>
                                                <button class="btn btn-default float-right" id="saveAssetLinkChangeButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                                {% if assets[0]['assets_linkedTo'] %}
                                                    <button class="btn btn-warning float-right" id="removeAssetLinkChangeButton" style="margin-top:10px;margin-bottom:10px;">Remove Link</button>
                                                {% endif %}

                                            </div>
                                            <div class="tab-pane" style="padding: 1.25rem" id="groups">
                                                <select class="form-control" id="assetGroups" multiple>
                                                    {% for group in assets[0]['groups'] %}
                                                        <option value="{{ group.assetGroups_id }}" selected="selected">{{group.assetGroups_name}}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="tab-pane" style="padding: 1.25rem" id="editAssetFields">
                                                <form id="editAssetDefinableFieldsForm">
                                                    {% for field in asset.fields %}
                                                        {% if field != "" %}
                                                            <div class="input-group definableFieldsGroup" data-fieldcount="{{loop.index}}">
                                                                <div class="input-group-prepend"><span class="input-group-text">{{field}}</span></div>
                                                                <input type="text" class="definableFieldsInput form-control" name="asset_definableFields_{{ loop.index }}" value="{{ assets[0]['asset_definableFields_' ~ loop.index] }}" data-fieldcount="{{loop.index}}" />
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </form>
                                                <button class="btn btn-default float-right" id="saveAssetDefinableFieldButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            {% if "ASSETS:EDIT:OVVERRIDES"|instancePermissions %}
                                                <div class="tab-pane" style="padding: 1.25rem" id="editAssetDetailsOverrides">
                                                    <div class="callout">
                                                        Overriding the details of the asset means that these settings below will take precedence over the properties for the type - this allows you to have multiple assets within a type with different masses for example
                                                    </div>
                                                    <form id="editAssetDetailsOverridesForm">
                                                        <div class="input-group">
                                                            <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Mass
                                                    </span>
                                                            </div>
                                                            <input type="number" step="0.001" min="0" name="assets_mass" value="{{ assets[0].assets_mass }}" class="form-control" />
                                                            <div class="input-group-append">
                                                                <div class="input-group-text">kg</div>
                                                            </div>
                                                        </div>
                                                        <div class="input-group">
                                                            <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Value - {{ moneySymbol() }}
                                                    </span>
                                                            </div>
                                                            <input type="number" step="0.001" min="0" name="assets_value" value="{{ assets[0].assets_value|moneyDecimal }}" class="form-control" />
                                                        </div>

                                                        <div class="input-group">
                                                            <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Day Rate - {{ moneySymbol() }}
                                                    </span>
                                                            </div>
                                                            <input type="number" step="0.001" min="0" name="assets_dayRate" value="{{ assets[0].assets_dayRate|moneyDecimal }}" class="form-control"  />
                                                        </div>
                                                        <div class="input-group">
                                                            <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                              Weekly Rate - {{ moneySymbol() }}
                                                            </span>
                                                            </div>
                                                            <input type="number" step="0.001" min="0" name="assets_weekRate" class="form-control" value="{{ assets[0].assets_weekRate|moneyDecimal }}" />
                                                        </div>
                                                    </form>
                                                    <button class="btn btn-default float-right" id="editAssetDetailsOverridesButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                                </div>
                                            {% endif %}
                                            <div class="tab-pane" style="padding: 1.25rem" id="editAssetType">
                                                <div class="callout callout-danger">
                                                    Changing the asset type for this asset can have significant implications especially with cost of existing projects and definable fields
                                                </div>
                                                <select class="form-control  select2bs4 assetSelect2" id="assetTypeChange" placeholder="{{ asset.assetTypes_name }}" value="{{ asset.assetTypes_id }}"></select>
                                                <button class="btn btn-default float-right" id="saveAssetTypeChangeButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            {% if "ASSETS:TRANSFER"|instancePermissions %}
                                            <div class="tab-pane" style="padding: 1.25rem" id="moveAsset">
                                                <div class="callout callout-danger">
                                                    <p>Transferring an asset to another business will archive it in this business, which will affect existing projects. When transferring, the following paramenters are not copied across to the other business: maintenance jobs, flags/blocks, file attachments, images, assignments to projects, barcodes, barcode scans &amp; groups</p>
                                                    <p>You can only transfer assets if you have the <code>ASSETS:TRANSFER</code> permission for the business you are transfering the asset into.</p> 
                                                </div>
                                                <div class="form-group">
                                                    <label for="assetMigrateInstance">Business to transfer asset to</label>
                                                    <select class="form-control select2bs4" id="assetMigrateInstance" placeholder="Select an Instance"></select>
                                                </div>
                                                <div class="form-group" style="display: none;">
                                                    <label for="assetMigrateAssetType">Asset Type for asset in new business</label>
                                                    <select class="form-control select2bs4" id="assetMigrateAssetType" placeholder="Select an Asset Type"></select>
                                                </div>
                                                <div class="form-group mt-2" style="display: none;">
                                                    <label for="assetMigrateManufacturer">New Asset Type Manufacturer</label>
                                                    <select class="form-control select2bs4" id="assetMigrateManufacturer" placeholder="Select a Manufacturer" aria-describedby="assetMigrateManufacturerHelp"></select>
                                                    <small id="assetMigrateManufacturerHelp" class="form-text text-muted">Select the manufacturer that this copied asset type should use</small>
                                                </div>
                                                <div class="form-group" style="display: none;">
                                                    <label for="assetMigrateCategory">New Asset Type Category</label>
                                                    <select class="form-control select2bs4" id="assetMigrateCategory" placeholder="Select a Category" aria-describedby="assetMigrateCategoryHelp"></select>
                                                    <small id="assetMigrateCategoryHelp" class="form-text text-muted">Which category should this asset type be placed in?</small>
                                                </div> 
                                                <button class="btn btn-default float-right" id="assetMigrate" style="margin-top:10px;margin-bottom:10px;">Migrate</button>                 
                                            </div>
                                            {% endif %}
                                        </div>
                                        <!-- /.tab-content -->
                                    </div><!-- /.card-body -->
                                </div>
                            </div>
                        {% endif %}

                        {% if CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and "ASSETS:ASSET_FILE_ATTACHMENTS:VIEW"|instancePermissions %}
                            <div class="tab-pane" style="padding: 1.25rem"  id="files">
                                {% if "ASSETS:ASSET_FILE_ATTACHMENTS:CREATE"|instancePermissions %}
                                    <div class="callout callout-default">
                                        Use this area to store files relevant to one asset such as an order confirmation or purchase invoice
                                    </div>
{% embed 'assets/templates/uppy.twig' with {'type': 'ASSET-FILE', 'paste': false, 'typeId': 4, 'subTypeId': assets[0]['assets_id'], 'imagesOnly': false } %}


                                        {% block success %}
                                            console.log(responseJson.id);
                                        {% endblock %}
                                    {% endembed %}
                                    <br/>
                                {% endif %}
{% embed 'assets/templates/fileBox.twig' with {'files': assets[0]['files'] } %}


                                {% endembed %}
                            </div>
                        {% endif %}
                        <div class="tab-pane" style="padding: 0" id="location">
                            <table class="table table-striped projects">
                                <thead>
                                <tr>
                                    <th>
                                        Timestamp
                                    </th>
                                    <th>
                                        Location
                                    </th>
                                    <th>
                                        Type
                                    </th>
                                    <th>
                                        User
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for scan in assets[0].locationScans %}
                                    <tr>
                                        <td>
                                             {{ scan.assetsBarcodesScans_timestamp|date("d M Y h:i:sa") }}
                                        </td>
                                        <td>
                                            {% if scan.locations_name %}
                                                {{ scan.locations_name }}
                                            {% elseif scan.assetTypes_name %}
                                                Inside asset {{  scan.assetTypes_name }} ({{ scan.assets_tag }})
                                            {% elseif scan.assetsBarcodes_customLocation %}
                                                {{  scan.assetsBarcodes_customLocation }}
                                            {% endif %}
                                            <br/><small>{{ scan.assetsBarcodesScans_validation }}</small>
                                        </td>
                                        <td>
                                            {% if scan.assetsBarcodesScans_barcodeWasScanned == "1" %}Barcode scanned{% else %}Location set manually{% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ scan.users_userid }}">{{ scan.users_name1 ~ " " ~ scan.users_name2 }}</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            {% if "LOCATIONS:VIEW"|instancePermissions and assets[0].barcodes[0] %}
                            <div class="callout callout-info m-2">
                                <p>Use the buttons below to set the location of this asset without scanning a barcode.</p>
                            </div>
                            <div class="btn-group m-2">
                                <button class="btn btn-info" id="setAssetLocationButton">Manually pick location from list</button>
                                <button class="btn btn-info" id="setAssetLocationAssetButton">Manually set location to be within another Asset</button>
                                <button class="btn btn-info" id="setCustomLocationButton">Manually set Custom Location</button>
                            </div>
                            {% endif %}
                        </div>
                        {% if "ASSETS:ASSET_BARCODES:VIEW"|instancePermissions  %}
                            <div class="tab-pane" style="padding: 0" id="barcodes">
                                <table class="table table-striped projects">
                                    <thead>
                                    <tr>
                                        <th>

                                        </th>
                                        <th>
                                            Barcode value
                                        </th>
                                        <th>
                                            Type
                                        </th>
                                        <th>
                                            Notes
                                        </th>
                                        <th>
                                            Creator
                                        </th>
                                        <th>
                                            Last Scanned
                                        </th>
                                        <th style="width:1%;">

                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for barcode in assets[0].barcodes %}
                                        <tr>
                                            <td>
                                                <img src="{{ CONFIG.ROOTURL }}/api/assets/barcodes/?barcode={{ barcode.assetsBarcodes_value }}&size=50&type={{ barcode.assetsBarcodes_type }}" alt="Barcode">
                                            </td>
                                            <td>
                                                {{ barcode.assetsBarcodes_value }}
                                            </td>
                                            <td>
                                                {{ barcode.assetsBarcodes_type }}
                                            </td>
                                            <td>
                                                {{ barcode.assetsBarcodes_notes }}
                                            </td>
                                            <td>
                                                <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ barcode.users_userid }}">
                                                    {{ barcode.users_name1 ~ ' ' ~ barcode.users_name2}}
                                                </a>
                                                <br/>
                                                <small>
                                                    Created {{barcode.assetsBarcodes_added|date("d M Y h:i:sa")}}
                                                </small>
                                            </td>
                                            <td>
                                                {% if barcode.latestScan %}
                                                    <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ barcode.latestScan.users_userid }}">
                                                        {{ barcode.latestScan.users_name1 ~ " " ~ barcode.latestScan.users_name2 }}
                                                    </a>
                                                    <br/>
                                                    <small>
                                                        {{ barcode.latestScan.assetsBarcodesScans_timestamp|date("d M Y h:i:sa") }}
                                                        {% if barcode.latestScan.locations_name %}
                                                            at {{ barcode.latestScan.locations_name }}
                                                        {% elseif barcode.latestScan.assetTypes_name %}
                                                            at asset {{ barcode.latestScan.assetTypes_name }} ({{ barcode.latestScan.assets_tag }})
                                                        {% elseif barcode.latestScan.assetsBarcodes_customLocation %}
                                                            at {{ barcode.latestScan.assetsBarcodes_customLocation }}
                                                        {% endif %}
                                                    </small>
                                                {% else %}
                                                    <i>Never scanned</i>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if "ASSETS:ASSET_BARCODES:DELETE"|instancePermissions %}
                                                    <button title="Delete" class="btn btn-sm btn-danger deleteBarcodeButton" data-barcodeid="{{ barcode['assetsBarcodes_id'] }}"><i class="fa fa-trash"></i></button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                                {% if ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
                                    <div class="row mx-0">
                                        <div class="col-6 px-1">
                                            <a class="btn btn-default btn-block" style="margin-bottom: 4px" href="{{ CONFIG.ROOTURL }}/maintenance/barcodeGenerator.php?id={{assets[0].assets_id}}">Generate/Export Barcodes</a>
                                        </div>
                                        {% if "ASSETS:ASSET_BARCODES:EDIT:ASSOCIATE_UNNASOCIATED_BARCODES_WITH_ASSETS"|instancePermissions %}
                                        <div class="col-6 px-1">
                                            <button class="btn btn-primary btn-block" style="margin-bottom: 4px" id="manuallyAssignBarcodeButton">Manually Assign Barcode</button>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% if "ASSETS:LABEL_PRINTERS:PRINT"|instancePermissions and labelPrinters|length > 0 %}
                                    <div class="row mx-0 mt-2">
                                        <div class="col-12 px-1">
                                            <button class="btn btn-success btn-block" id="printLabelBtn">
                                                <i class="fas fa-print"></i> Print Label
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endif %}
                        {% if "ASSETS:ASSET_BARCODES:EDIT:ASSOCIATE_UNNASOCIATED_BARCODES_WITH_ASSETS"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
                        <div class="modal fade" id="manuallyAssignBarcodeModal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h4 class="modal-title">Manually Assign Barcode</h4>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <p>Assign a barcode to this asset by selecting the barcode type and entering the barcode value.</p>
                                        <form id="manuallyAssignBarcodeForm">
                                            <div class="form-group">
                                                <label for="barcodeType">Barcode Type</label>
                                                <select class="form-control select2-barcode" id="barcodeType" name="barcodeType" required style="width: 100%;">
                                                    <option value="">Select barcode type...</option>
                                                    <option value="EAN_8" data-desc="8-digit linear barcode">EAN-8</option>
                                                    <option value="EAN_13" data-desc="13-digit linear barcode">EAN-13</option>
                                                    <option value="CODE_39" data-desc="Alphanumeric linear barcode">CODE-39</option>
                                                    <option value="CODE_93" data-desc="Compact linear barcode">CODE-93</option>
                                                    <option value="CODE_128" data-desc="High-density linear barcode">CODE-128</option>
                                                    <option value="UPC_A" data-desc="12-digit product barcode">UPC-A</option>
                                                    <option value="UPC_E" data-desc="Compact UPC barcode">UPC-E</option>
                                                    <option value="QR_CODE" data-desc="2D matrix barcode">QR Code</option>
                                                </select>
                                                <small class="form-text text-muted">Select the format of the barcode</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="barcodeValue">Barcode Value</label>
                                                <input type="text" class="form-control" id="barcodeValue" name="barcodeValue" placeholder="e.g., 100001" required>
                                                <small class="form-text text-muted" id="barcodeValueHint">Enter the barcode number/text</small>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" id="manuallyAssignBarcodeSubmit">Assign Barcode</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if "MAINTENANCE_JOBS:VIEW"|instancePermissions %}
                            <div class="tab-pane" style="padding:0"  id="maintenance">
                                <div class="card" style="margin-bottom:0;">
                                    <div class="card-header p-2">
                                        <ul class="nav nav-pills">
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-newJob" data-toggle="tab">New Job</a></li>
                                            <li class="nav-item"><a class="nav-link active" href="#maintenance-flags" data-toggle="tab">Blocks &amp; Flags</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-jobsOutstanding" data-toggle="tab">Jobs Outstanding</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-jobsCompleted" data-toggle="tab">Jobs Completed</a></li>
                                            {% if "MAINTENANCE_JOBS:SCHEDULES:VIEW"|instancePermissions %}<li class="nav-item"><a class="nav-link" href="#maintenance-schedules" data-toggle="tab">Scheduled Maintenance</a></li>{% endif %}
                                        </ul>
                                    </div><!-- /.card-header -->
                                    <div class="card-body" style="padding: 0;">
                                        <div class="tab-content">
                                            <div class="tab-pane" style="padding: 1.25rem" id="maintenance-newJob">
                                                <style>
                                                    .input-group {
                                                        margin-bottom: 5px;
                                                    }
                                                </style>
                                                <form id="addNewJobForm">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Asset</span></div>
                                                        <input type="text" class="form-control" disabled value="{{ assets[0].assets_tag|aTag }}" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Title</span></div>
                                                        <input type="text" class="form-control" name="maintenanceJobs_title" id="maintenanceJobstitle" placeholder="Drum revolve key missing" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Fault Description</span></div>
                                                        <textarea class="form-control" rows="5" name="maintenanceJobs_faultDescription" id="maintenanceJobsfaultDescription" placeholder="Details of the fault"></textarea>
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                              Priority
                                                            </span>
                                                        </div>
                                                        <select class="form-control" name="maintenanceJobs_priority">
                                                            {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                <option value="{{ type.id }}" {% if type.default %}selected{% endif %}>{{ type.text }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="input-group">
                                                        <label>Tag Users</label>
                                                        <select class="form-control" multiple="multiple" placeholder="Select users to be tagged for updates in the job" id="tagUserInJob">
                                                        </select>
                                                    </div>
                                                </form>

                                                <button class="btn btn-default float-right" id="addNewJobButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            <div class="active tab-pane" style="padding: 1.25rem" id="maintenance-flags">
                                                {% for flag in assets[0].flagsblocks.BLOCK %}
                                                    <div class="alert alert-danger">
                                                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button" style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                                                        <h5><i class="fas fa-ban"></i> {{ flag.maintenanceJobs_title }}</h5>
                                                        {{ flag.maintenanceJobs_faultDescription }}
                                                    </div>
                                                {% endfor %}
                                                {% for flag in assets[0].flagsblocks.FLAG %}
                                                    <div class="alert alert-warning">
                                                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button"  style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                                                        <h5><i class="far fa-flag"></i> {{ flag.maintenanceJobs_title }}</h5>
                                                        {{ flag.maintenanceJobs_faultDescription }}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            <div class="tab-pane" style="padding: 0;" id="maintenance-jobsOutstanding">
                                                <table class="table table-striped projects">
                                                    <thead>
                                                    <tr>
                                                        <th style="width: 1%">
                                                            #
                                                        </th>
                                                        <th>
                                                            Title
                                                        </th>
                                                        <th style="width: 5%">
                                                            Creator
                                                        </th>
                                                        <th style="width: 5%">
                                                            Assigned
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Priority
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Status
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-flag"></i>
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-ban"></i>
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for job in assets[0].jobs %}
                                                        {% if job.maintenanceJobsStatuses_id != 2 %}
                                                            <tr>
                                                                <td>
                                                                    <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ job.maintenanceJobs_id }}">#{{ job.maintenanceJobs_id }}</a>
                                                                </td>
                                                                <td>
                                                                    <a>
                                                                        {{ job.maintenanceJobs_title }}
                                                                    </a>
                                                                    <br/>
                                                                    <small>
                                                                        Created {{job.maintenanceJobs_timestamp_added|date("d M Y h:i:sa")}}
                                                                    </small>
                                                                </td>
                                                                <td>
                                                                    <ul class="list-inline">
                                                                        <li class="list-inline-item">
                                                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userCreatorUserID }}" title="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 ~ " (" ~ job.userCreatorUserEMail ~ ")" }}">
                                                                            <img loading="lazy" alt="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 }}" class="table-avatar" src="{{ CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and job.userCreatorUserThumb ? job.userCreatorUserThumb|s3URL("small") : CONFIG.ROOTURL ~ '/api/file/avatarGen.php?users_userid=' ~ job.userCreatorUserID }}">
                                                                            </a>
                                                                        </li>
                                                                    </ul>
                                                                </td>
                                                                <td>
                                                                    {% if job.userAssignedUserName1 != null %}
                                                                        <ul class="list-inline">
                                                                            <li class="list-inline-item">
                                                                                <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userAssignedUserID }}" title="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}">
                                                                                    <img loading="lazy" alt="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}" class="table-avatar" src="{{ CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and job.userAssignedUserThumb ? job.userAssignedUserThumb|s3URL("small") : CONFIG.ROOTURL ~ '/api/file/avatarGen.php?users_userid=' ~ job.userAssignedUserID }}">
                                                                                </a>
                                                                            </li>
                                                                        </ul>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobs_priority %}
                                                                        {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                            <span class="badge badge-{{ type.class }}" value="{{ type.id }}" {% if job.maintenanceJobs_priority != type.id %} style="display: none;" {% endif %}>{{ type.text }}</span>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobsStatuses_name %}
                                                                        <span class="badge badge-default">{{ job.maintenanceJobsStatuses_name }}</span>
                                                                    {% else %}
                                                                        <span class="badge badge-default">Awaiting Sorting</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_flagAssets == 1 %}
                                                                        <i class="fas fa-flag"></i>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_blockAssets == 1 %}
                                                                        <i class="fas fa-ban"></i>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="tab-pane" style="padding: 0" id="maintenance-jobsCompleted">
                                                <table class="table table-striped projects">
                                                    <thead>
                                                    <tr>
                                                        <th style="width: 1%">
                                                            #
                                                        </th>
                                                        <th>
                                                            Title
                                                        </th>
                                                        <th style="width: 5%">
                                                            Creator
                                                        </th>
                                                        <th style="width: 5%">
                                                            Assigned
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Priority
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Status
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-flag"></i>
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-ban"></i>
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for job in assets[0].jobs %}
                                                        {% if job.maintenanceJobsStatuses_id == 2 %}
                                                            <tr>
                                                                <td>
                                                                    <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ job.maintenanceJobs_id }}">#{{ job.maintenanceJobs_id }}</a>
                                                                </td>
                                                                <td>
                                                                    <a>
                                                                        {{ job.maintenanceJobs_title }}
                                                                    </a>
                                                                    <br/>
                                                                    <small>
                                                                        Created {{job.maintenanceJobs_timestamp_added|date("d M Y h:i:sa")}}
                                                                    </small>
                                                                </td>
                                                                <td>
                                                                    <ul class="list-inline">
                                                                        <li class="list-inline-item">
                                                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userCreatorUserID }}" title="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 ~ " (" ~ job.userCreatorUserEMail ~ ")" }}">
                                                                                <img loading="lazy" alt="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 }}" class="table-avatar" src="{{ CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and job.userCreatorUserThumb ? job.userCreatorUserThumb|s3URL("small") : CONFIG.ROOTURL ~ '/api/file/avatarGen.php?users_userid=' ~ job.userCreatorUserID }}">
                                                                            </a>
                                                                        </li>
                                                                    </ul>
                                                                </td>
                                                                <td>
                                                                    {% if job.userAssignedUserName1 != null %}
                                                                        <ul class="list-inline">
                                                                            <li class="list-inline-item">
                                                                                <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userAssignedUserID }}" title="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}">
                                                                                    <img loading="lazy" alt="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}" class="table-avatar" src="{{ CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and job.userAssignedUserThumb ? job.userAssignedUserThumb|s3URL("small") : CONFIG.ROOTURL ~ '/api/file/avatarGen.php?users_userid=' ~ job.userAssignedUserID }}">
                                                                                </a>
                                                                            </li>
                                                                        </ul>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobs_priority %}
                                                                        {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                            <span class="badge badge-{{ type.class }}" value="{{ type.id }}" {% if job.maintenanceJobs_priority != type.id %} style="display: none;" {% endif %}>{{ type.text }}</span>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobsStatuses_name %}
                                                                        <span class="badge badge-default">{{ job.maintenanceJobsStatuses_name }}</span>
                                                                    {% else %}
                                                                        <span class="badge badge-default">Awaiting Sorting</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_flagAssets == 1 %}
                                                                        <i class="fas fa-flag"></i>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_blockAssets == 1 %}
                                                                        <i class="fas fa-ban"></i>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            {% if "MAINTENANCE_JOBS:SCHEDULES:VIEW"|instancePermissions %}
                                            <div class="tab-pane" style="padding: 1.25rem" id="maintenance-schedules">
                                                <h5>Scheduled Maintenance</h5>
                                                <p class="text-muted">Automatically create maintenance jobs when assets are due for periodic maintenance (e.g., test and tag, PAT testing).</p>

                                                {% if "MAINTENANCE_JOBS:SCHEDULES:CREATE"|instancePermissions %}
                                                <button class="btn btn-success mb-3" id="addScheduleButton"><i class="fas fa-plus"></i> Add Schedule</button>

                                                <div id="scheduleForm" style="display: none; margin-bottom: 20px;">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h5 class="card-title mb-0" id="scheduleFormTitle">Add Scheduled Maintenance</h5>
                                                        </div>
                                                        <div class="card-body">
                                                            <form id="scheduleFormElement">
                                                                <input type="hidden" id="schedule_id" value="">

                                                                <div class="form-group">
                                                                    <label for="schedule_type">Maintenance Type <span class="text-danger">*</span></label>
                                                                    <input type="text" class="form-control" id="schedule_type" placeholder="e.g., Test and Tag, PAT Testing, Service" required>
                                                                    <small class="form-text text-muted">Type of maintenance (e.g., "Test and Tag", "PAT Testing")</small>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label for="schedule_nextDue">Next Due Date <span class="text-danger">*</span></label>
                                                                    <input type="date" class="form-control" id="schedule_nextDue" required>
                                                                    <small class="form-text text-muted">When this maintenance is next due</small>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label for="schedule_intervalMonths">Interval (Optional)</label>
                                                                    <select class="form-control" id="schedule_intervalMonths">
                                                                        <option value="">No recurring interval</option>
                                                                        <option value="3">3 months</option>
                                                                        <option value="6">6 months</option>
                                                                        <option value="12">12 months (1 year)</option>
                                                                        <option value="24">24 months (2 years)</option>
                                                                        <option value="36">36 months (3 years)</option>
                                                                        <option value="60">60 months (5 years)</option>
                                                                    </select>
                                                                    <small class="form-text text-muted">Suggested interval for future maintenance (can be changed later)</small>
                                                                </div>

                                                                <div class="form-check mb-3">
                                                                    <input type="checkbox" class="form-check-input" id="schedule_enabled" checked>
                                                                    <label class="form-check-label" for="schedule_enabled">Enabled</label>
                                                                    <br><small class="form-text text-muted">Schedule is active</small>
                                                                </div>

                                                                <div class="form-check mb-3">
                                                                    <input type="checkbox" class="form-check-input" id="schedule_blockWhenOverdue" checked>
                                                                    <label class="form-check-label" for="schedule_blockWhenOverdue">Block asset when overdue</label>
                                                                    <br><small class="form-text text-muted">Prevent asset from being scanned out when overdue</small>
                                                                </div>

                                                                <div class="form-check mb-3">
                                                                    <input type="checkbox" class="form-check-input" id="schedule_autoCreateJob" checked>
                                                                    <label class="form-check-label" for="schedule_autoCreateJob">Auto-create maintenance job when overdue</label>
                                                                    <br><small class="form-text text-muted">Automatically create a maintenance job when due date arrives</small>
                                                                </div>

                                                                <button type="submit" class="btn btn-primary" id="saveScheduleButton">Save Schedule</button>
                                                                <button type="button" class="btn btn-secondary" id="cancelScheduleButton">Cancel</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}

                                                <div id="schedulesList">
                                                    {% if assets[0].schedules is defined and assets[0].schedules|length > 0 %}
                                                        <table class="table table-striped">
                                                            <thead>
                                                                <tr>
                                                                    <th>Type</th>
                                                                    <th>Next Due</th>
                                                                    <th>Interval</th>
                                                                    <th>Status</th>
                                                                    <th>Blocks Asset</th>
                                                                    <th>Auto-Create Job</th>
                                                                    <th style="width: 120px;">Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="schedulesTableBody">
                                                                {% for schedule in assets[0].schedules %}
                                                                <tr data-schedule-id="{{ schedule.assetMaintenanceSchedules_id }}">
                                                                    <td>{{ schedule.assetMaintenanceSchedules_type }}</td>
                                                                    <td>
                                                                        {{ schedule.assetMaintenanceSchedules_nextDue|date("d M Y") }}
                                                                        {% if schedule.assetMaintenanceSchedules_nextDue|date("U") < "now"|date("U") %}
                                                                            <span class="badge badge-danger ml-1">Overdue</span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if schedule.assetMaintenanceSchedules_intervalMonths %}
                                                                            {{ schedule.assetMaintenanceSchedules_intervalMonths }} months
                                                                        {% else %}
                                                                            <span class="text-muted">None</span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if schedule.assetMaintenanceSchedules_enabled == 1 %}
                                                                            <span class="badge badge-success">Enabled</span>
                                                                        {% else %}
                                                                            <span class="badge badge-secondary">Disabled</span>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if schedule.assetMaintenanceSchedules_blockWhenOverdue == 1 %}
                                                                            <i class="fas fa-check text-success"></i>
                                                                        {% else %}
                                                                            <i class="fas fa-times text-muted"></i>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if schedule.assetMaintenanceSchedules_autoCreateJob == 1 %}
                                                                            <i class="fas fa-check text-success"></i>
                                                                        {% else %}
                                                                            <i class="fas fa-times text-muted"></i>
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        {% if "MAINTENANCE_JOBS:SCHEDULES:EDIT"|instancePermissions %}
                                                                        <button class="btn btn-sm btn-info editScheduleButton" data-schedule='{{ schedule|json_encode|e('html_attr') }}'><i class="fas fa-edit"></i></button>
                                                                        {% endif %}
                                                                        {% if "MAINTENANCE_JOBS:SCHEDULES:DELETE"|instancePermissions %}
                                                                        <button class="btn btn-sm btn-danger deleteScheduleButton" data-id="{{ schedule.assetMaintenanceSchedules_id }}"><i class="fas fa-trash"></i></button>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    {% else %}
                                                        <div class="alert alert-info">
                                                            <i class="fas fa-info-circle"></i> No scheduled maintenance configured for this asset.
                                                            {% if "MAINTENANCE_JOBS:SCHEDULES:CREATE"|instancePermissions %}
                                                                Click "Add Schedule" above to create one.
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <!-- /.tab-content -->
                                    </div><!-- /.card-body -->
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <!-- /.tab-content -->
                </div><!-- /.card-body -->
            </div>
            {% endif %}
            <div class="card card-info card-outline">
                <div class="card-header p-2">
                    <ul class="nav nav-pills">
                        {% if asset.oneasset %}
                            <li class="nav-item"><a class="nav-link" href="?id={{asset.assetTypes_id}}&instance={{ASSET_INSTANCE.instances_id}}">View All</a></li>
                        {% elseif assets|length > 1 %}
                            <li class="nav-item"><a class="nav-link" href="#assets" data-toggle="tab">Assets</a></li>
                        {% endif %}

                        {% if assets|length > 1 and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
                        <li class="nav-item"><a class="nav-link active" href="#calendarBox" data-toggle="tab"><i class="far fa-calendar-alt"></i></a></li>
                        {% endif %}


                        {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                            <li class="nav-item"><a class="nav-link" href="#settings" data-toggle="tab">Edit Type</a></li>
                        {% endif %}
                        {% if CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and "ASSETS:ASSET_TYPE_FILE_ATTACHMENTS:VIEW"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                            <li class="nav-item"><a class="nav-link" href="#typeFiles" data-toggle="tab">Type Files</a></li>
                        {% endif %}
                        {% if "ASSETS:ASSET_BARCODES:VIEW"|instancePermissions  and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
                            <li class="nav-item"><a class="nav-link" href="{{ CONFIG.ROOTURL }}/maintenance/barcodeGenerator.php?type={{ asset.assetTypes_id }}">Generate/Export Barcodes</a></li>
                        {% endif %}
                    </ul>
                </div><!-- /.card-header -->
                <div class="card-body" style="padding: 0;">
                    <div class="tab-content">
                        <div class="tab-pane table-responsive p-0" id="assets" style="height: 600px;">
                            <table class="table table-head-fixed">
                                <tr>
                                    <th style="width:70px;">ID</th>
                                    {% for field in asset.fields %}
                                        <th>{{ field }}</th>
                                    {% endfor %}
                                    <th>Notes</th>
                                    <th>Value</th>
                                    <th>Cost/day</th>
                                    <th>Cost/week</th>
                                    <th title="File attachments"><i class="fas fa-paperclip"></i></th>
                                    <th style="width:1%"><i class="fas fa-flag"></i></th>
                                    <th style="width:1%"><i class="fas fa-ban"></i></th>
                                    <th style="width:30px;"></th>
                                </tr>
                                {% for thisasset in assets %}
                                    <tr>
                                        <td><a href="?id={{ asset.assetTypes_id }}&asset={{ thisasset.assets_id }}&instance={{ASSET_INSTANCE.instances_id}}">{{ thisasset.assets_tag|aTag }}</a></td>
                                        {% for field in asset.fields %}
                                            <td>{{ thisasset['asset_definableFields_' ~ loop.index] }}</td>
                                        {% endfor %}
                                        <td>{{ thisasset['assets_notes']|nl2br }}</td>
                                        <td>
                                            {{ (thisasset.assets_value ?: asset.assetTypes_value)|money(ASSET_INSTANCE['instances_config_currency']) }}
                                        </td>
                                        <td>
                                            {{ (thisasset.assets_dayRate ?: asset.assetTypes_dayRate)|money(ASSET_INSTANCE['instances_config_currency']) }}
                                        </td>
                                        <td>
                                            {{ (thisasset.assets_weekRate ?: asset.assetTypes_weekRate)|money(ASSET_INSTANCE['instances_config_currency']) }}
                                        </td>
                                        <td>{{ thisasset.files|length > 0 ?: "" }}</td>

                                        <td>
                                            {{ thisasset.flagsblocks.COUNT.FLAG > 0 ?: '' }}
                                        </td>
                                        <td>
                                            {{ thisasset.flagsblocks.COUNT.BLOCK > 0 ?: '' }}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                {% if "ASSETS:ARCHIVE"|instancePermissions and (thisasset.assets_endDate is null or thisasset.assets_endDate|date("U") > "now"|date("U"))  and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
                                                    <button title="Archive" class="btn btn-sm btn-warning archiveAssetButton" data-assetid="{{ thisasset['assets_id'] }}"><i class="fas fa-archive"></i></button>
                                                {% endif %}
                                                {% if "ASSETS:DELETE"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                                                    <button title="Delete" class="btn btn-sm btn-danger deleteAssetButton" data-assetid="{{ thisasset['assets_id'] }}"><i class="fa fa-trash"></i></button>
                                                {% endif %}


                                                <a class="btn btn-sm btn-info" title="View" href="?id={{ asset.assetTypes_id }}&asset={{ thisasset.assets_id }}&instance={{ASSET_INSTANCE.instances_id}}"><i class="far fa-arrow-alt-circle-right"></i></a>
                                                </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                        <!-- /.tab-pane -->
                        {% if assets|length > 1 %}
                        <div class="active tab-pane" style="padding: 1.25rem" id="calendarBox">
                            <div id="calendar"></div>
                            <script>
                                $(function () {
                                    /* initialize the calendar
                                     -----------------------------------------------------------------*/
                                    var Calendar = FullCalendar.Calendar;

                                    var calendarEl = document.getElementById('calendar');

                                    // initialize the external events
                                    // -----------------------------------------------------------------

                                    var calendar = new Calendar(calendarEl, {
                                        themeSystem: 'bootstrap',
                                        buttonText:  {
                                            today:    'Today',
                                            month:    'Month',
                                            week:     'Week',
                                            day:      'Day',
                                            list:     'List'
                                        },
                                        headerToolbar : {
                                            left  : 'prev,next today',
                                            center: 'title',
                                            right : 'dayGridMonth'
                                        },
                                        //Random default events
                                        events    : [
                                            {% set earliestStart = false %}
                                            {% set latestEnd = false %}
                                            {% for thisasset in assets %}
                                                {% for assignment in thisasset.assignments %}
                                                {
                                                    title          : '{% if USERDATA['instance']['calendarSettings'].showProjectStatus %}[{{ assignment.projectsStatuses_name }}] {% endif %}{{ assignment.projects_name }}',
                                                    start          : Date.parse("{{ assignment.projects_dates_deliver_start|date("c") }}"),
                                                    end            : Date.parse("{{ assignment.projects_dates_deliver_end|date("c") }}"),
                                                    url            : '{{CONFIG.ROOTURL}}/project/?id={{ assignment.projects_id }}',
                                                    backgroundColor: '{{ assignment.projectsStatuses_backgroundColour }}',
                                                    textColor    : '{{ assignment.projectsStatuses_foregroundColour }}'
                                                },
                                                {% if earliestStart > assignment.projects_dates_deliver_start|date("c") or earliestStart == false %}
                                                    {% set earliestStart = assignment.projects_dates_deliver_start|date("c") %}
                                                {% endif %}
                                                {% if latestEnd < assignment.projects_dates_deliver_end|date("c") or latestEnd == false %}
                                                    {% set latestEnd = assignment.projects_dates_deliver_end|date("c") %}
                                                {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        ],
                                        validRange: {
                                            start: '{{ earliestStart|date("c") }}',
                                            end: '{{ latestEnd|date("c") }}'
                                        },
                                        editable  : false,
                                        droppable : false, // this allows things to be dropped onto the calendar !!!
                                        height: 600,
                                        firstDay: 1
                                    });

                                    calendar.render();
                                })
                            </script>
                        </div>
                        {% endif %}
                        {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions and (asset.assetInstances_id != null or "ASSETS:EDIT:ANY_ASSET_TYPE"|serverPermissions) and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                        <div class="tab-pane" style="padding:0"  id="settings">
                            <div class="card" style="margin-bottom:0;">
                                <div class="card-header p-2">
                                    <ul class="nav nav-pills">
                                        <li class="nav-item"><a class="nav-link active" href="#details" data-toggle="tab">Details</a></li>
                                        <li class="nav-item"><a class="nav-link" href="#fields" data-toggle="tab">Custom Fields</a></li>
                                        <li class="nav-item"><a class="nav-link" href="#thumbnail" data-toggle="tab">Thumbnails</a></li>
                                    </ul>
                                </div><!-- /.card-header -->
                                <div class="card-body" style="padding: 0;">
                                    <div class="tab-content">
                                        <div class="active tab-pane" style="padding: 1.25rem" id="details">
                                            <style>
                                                .input-group {
                                                    margin-bottom: 5px;
                                                }
                                            </style>
                                            <form id="addNewForm">
                                            <div class="input-group">
                                                <div class="input-group-prepend"><span class="input-group-text">Name</span></div>
                                                <input type="text" class="form-control" name="assetTypes_name" value="{{ asset.assetTypes_name}}" id="addNewType-name" />
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend"><span class="input-group-text">Description</span></div>
                                                <textarea class="form-control" rows="3" name="assetTypes_description" id="addNewType-description"  placeholder="">{{ asset.assetTypes_description}}</textarea>
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend"><span class="input-group-text">Product Link</span></div>
                                                <input type="url" class="form-control" name="assetTypes_productLink" value="{{ asset.assetTypes_productLink }}" id="addNewType-productLink" maxlength="499" />
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Mass
                                                    </span>
                                                </div>
                                                <input type="number" step="0.001" min="0" name="assetTypes_mass" value="{{ asset.assetTypes_mass}}" class="form-control" id="addNewType-mass" />
                                                <div class="input-group-append">
                                                    <div class="input-group-text">kg</div>
                                                </div>
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Value - {{ moneySymbol() }}
                                                    </span>
                                                </div>
                                                <input type="number" step="0.001" min="0" name="assetTypes_value" value="{{ asset.assetTypes_value|moneyDecimal }}" class="form-control" id="addNewType-value" />
                                            </div>

                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Day Rate - {{ moneySymbol() }}
                                                    </span>
                                                </div>
                                                <input type="number" step="0.001" min="0" name="assetTypes_dayRate" value="{{ asset.assetTypes_dayRate|moneyDecimal }}" class="form-control" id="addNewType-dayRate" />
                                                <div class="input-group-append">
                                                    <div class="input-group-text" id="addNewType-dayRate-guide">Guide 2% of value</div>
                                                </div>
                                            </div>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                      Weekly Rate - {{ moneySymbol() }}
                                                    </span>
                                                </div>
                                                <input type="number" step="0.001" min="0" name="assetTypes_weekRate" class="form-control" value="{{ asset.assetTypes_weekRate|moneyDecimal }}" id="addNewType-weekRate" />
                                                <div class="input-group-append">
                                                    <div class="input-group-text" id="addNewType-weekRate-guide">Guide 6% of value</div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label>Category</label>
                                                <select class="form-control  select2bs4 assetSelect2" id="category" name="assetCategories_id">
                                                    {% for category in categories %}
                                                        <option  {%  if category.assetCategories_id == asset.assetCategories_id %} selected {% endif %} value="{{ category.assetCategories_id }}">{{ category.assetCategoriesGroups_name }} - {{ category.assetCategories_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <label>Manufacturer</label>
                                            <select class="form-control  select2bs4 assetSelect2" id="manufacturer">
                                                {% for manufacturer in manufacturers %}
                                                    <option {%  if manufacturer.manufacturers_id == asset.manufacturers_id %} selected {% endif %} value="{{ manufacturer.manufacturers_id }}">{{ manufacturer.manufacturers_name }}</option>
                                                {% endfor %}
                                            </select>
                                            </form>
                                            <button class="btn btn-default float-right" id="saveSettingsButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                        </div>
                                        <div class="tab-pane" style="padding: 1.25rem" id="fields">
                                            <div class="callout callout-info">
                                                <p>Definable fields are specific attributes for assets of this type - for a lighting fixture this might be the lens fitted</p>
                                            </div>
                                            <form id="editDefinableFieldsType">
                                            {% for field in asset.fields %}
                                                <div class="input-group definableFieldsGroup" data-fieldcount="{{loop.index}}">
                                                    <div class="input-group-prepend"><span class="input-group-text">Definable Field {{loop.index}}</span></div>
                                                    <input type="text" class="definableFieldsInput form-control" name="asset_definableFields_{{ loop.index }}" value="{{field}}" data-fieldcount="{{loop.index}}" />
                                                </div>
                                            {% endfor %}
                                            </form>
                                            <div class="callout callout-danger">
                                                <p>Leave a field blank to delete it</p>
                                            </div>
                                            <button class="btn btn-default float-right" id="saveTypeDefinableFieldButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                        </div>
                                        <div class="tab-pane" style="padding: 1.25rem" id="thumbnail">
{% if CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and "ASSETS:ASSET_TYPE_FILE_ATTACHMENTS:CREATE"|instancePermissions %}

{% embed 'assets/templates/uppy.twig' with {'type': 'ASSET-THUMBNAIL', 'paste': true, 'typeId': 2, 'subTypeId': asset.assetTypes_id, 'imagesOnly': true } %}


                                                    {% block success %}
                                                        console.log(responseJson.id);
                                                    {% endblock %}
                                                {% endembed %}
                                                <br/>
                                            {% endif %}
{% embed 'assets/templates/fileBox.twig' with {'files': asset.thumbnail, 'galleryOnly': true } %}


                                            {% endembed %}
                                        </div>
                                    </div>
                                    <!-- /.tab-content -->
                                </div><!-- /.card-body -->
                            </div>
                        </div>
                        {% elseif "ASSETS:ASSET_TYPES:EDIT"|instancePermissions %}
                        <div class="tab-pane" style="padding: 1.25rem" id="settings">
                            <div class="alert alert-info" role="alert">
<h4 class="alert-heading">Asset type maintained by the {{ CONFIG.PROJECT_NAME }}</h4>Sorry - this asset type is shared between a number of different businesses as a pre-defined template, to edit it please
<a href="{{ CONFIG.LINKS_SUPPORTURL }}">get in touch with support</a>

                            </div>
                        </div>
                        {% endif %}

                        {% if CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and "ASSETS:ASSET_TYPE_FILE_ATTACHMENTS:VIEW"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}

                        <div class="tab-pane" style="padding: 1.25rem"  id="typeFiles">
                            {% if "ASSETS:ASSET_TYPE_FILE_ATTACHMENTS:CREATE"|instancePermissions %}
                            <div class="callout callout-default">
                                Use this area to store files relevant to all assets of this type such as instruction manuals
                            </div>
{% embed 'assets/templates/uppy.twig' with {'type': 'ASSET-TYPE-FILE', 'paste': false, 'typeId': 3, 'subTypeId': asset.assetTypes_id, 'imagesOnly': false } %}


                                {% block success %}
                                    console.log(responseJson.id);
                                {% endblock %}
                            {% endembed %}
                            <br/>
                            {% endif %}
{% embed 'assets/templates/fileBox.twig' with {'files': asset.files } %}


                            {% endembed %}
                        </div>
                        {% endif %}
                        {% if "MAINTENANCE_JOBS:VIEW"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id  %}
                            <div class="tab-pane" style="padding:0"  id="maintenance">
                                <div class="card" style="margin-bottom:0;">
                                    <div class="card-header p-2">
                                        <ul class="nav nav-pills">
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-newJob" data-toggle="tab">New Job</a></li>
                                            <li class="nav-item"><a class="nav-link active" href="#maintenance-flags" data-toggle="tab">Blocks &amp; Flags</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-jobsOutstanding" data-toggle="tab">Jobs Outstanding</a></li>
                                            <li class="nav-item"><a class="nav-link" href="#maintenance-jobsCompleted" data-toggle="tab">Jobs Completed</a></li>
                                        </ul>
                                    </div><!-- /.card-header -->
                                    <div class="card-body" style="padding: 0;">
                                        <div class="tab-content">
                                            <div class="tab-pane" style="padding: 1.25rem" id="maintenance-newJob">
                                                <style>
                                                    .input-group {
                                                        margin-bottom: 5px;
                                                    }
                                                </style>
                                                <form id="addNewJobForm">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Asset</span></div>
                                                        <input type="text" class="form-control" disabled value="{{ assets[0].assets_tag|aTag }}" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Title</span></div>
                                                        <input type="text" class="form-control" name="maintenanceJobs_title" id="maintenanceJobstitle" placeholder="Drum revolve key missing" />
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><span class="input-group-text">Fault Description</span></div>
                                                        <textarea class="form-control" rows="5" name="maintenanceJobs_faultDescription" id="maintenanceJobsfaultDescription" placeholder="Details of the fault"></textarea>
                                                    </div>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                              Priority
                                                            </span>
                                                        </div>
                                                        <select class="form-control" name="maintenanceJobs_priority">
                                                            {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                <option value="{{ type.id }}" {% if type.default %} selected {% endif %}>{{ type.text }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="input-group">
                                                        <label>Tag Users</label>
                                                        <select class="form-control" multiple="multiple" placeholder="Select users to be tagged for updates in the job" id="tagUserInJob">
                                                        </select>
                                                    </div>
                                                </form>

                                                <button class="btn btn-default float-right" id="addNewJobButton" style="margin-top:10px;margin-bottom:10px;">Save</button>
                                            </div>
                                            <div class="active tab-pane" style="padding: 1.25rem" id="maintenance-flags">
                                                {% for flag in assets[0].flagsblocks.BLOCK %}
                                                    <div class="alert alert-danger">
                                                        <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button" style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                                                        <h5><i class="fas fa-ban"></i> {{ flag.maintenanceJobs_title }}</h5>
                                                        {{ flag.maintenanceJobs_faultDescription }}
                                                    </div>
                                                {% endfor %}
                                                {% for flag in assets[0].flagsblocks.FLAG %}
                                                <div class="alert alert-warning">
                                                    <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ flag.maintenanceJobs_id }}" type="button"  style="text-decoration: none;" class="close"><i class="fas fa-info-circle"></i></a>
                                                    <h5><i class="far fa-flag"></i> {{ flag.maintenanceJobs_title }}</h5>
                                                    {{ flag.maintenanceJobs_faultDescription }}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <div class="tab-pane" style="padding: 0;" id="maintenance-jobsOutstanding">
                                                <table class="table table-striped projects">
                                                    <thead>
                                                    <tr>
                                                        <th style="width: 1%">
                                                            #
                                                        </th>
                                                        <th>
                                                            Title
                                                        </th>
                                                        <th style="width: 5%">
                                                            Creator
                                                        </th>
                                                        <th style="width: 5%">
                                                            Assigned
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Priority
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Status
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-flag"></i>
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-ban"></i>
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for job in assets[0].jobs %}
                                                        {% if job.maintenanceJobsStatuses_id != 2 %}
                                                        <tr>
                                                            <td>
                                                                <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ job.maintenanceJobs_id }}">#{{ job.maintenanceJobs_id }}</a>
                                                            </td>
                                                            <td>
                                                                <a>
                                                                    {{ job.maintenanceJobs_title }}
                                                                </a>
                                                                <br/>
                                                                <small>
                                                                    Created {{job.maintenanceJobs_timestamp_added|date("d M Y h:i:sa")}}
                                                                </small>
                                                            </td>
                                                            <td>
                                                                <ul class="list-inline">
                                                                    <li class="list-inline-item">
                                                                        <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userCreatorUserID }}" title="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 ~ " (" ~ job.userCreatorUserEMail ~ ")" }}">
                                                                            <img loading="lazy" alt="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 }}" class="table-avatar" src="{{ CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and job.userCreatorUserThumb ? job.userCreatorUserThumb|s3URL("small") : CONFIG.ROOTURL ~ '/api/file/avatarGen.php?users_userid=' ~ job.userCreatorUserID }}">
                                                                        </a>
                                                                    </li>
                                                                </ul>
                                                            </td>
                                                            <td>
                                                                {% if job.userAssignedUserName1 != null %}
                                                                    <ul class="list-inline">
                                                                        <li class="list-inline-item">
                                                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userAssignedUserID }}" title="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}">
                                                                                <img loading="lazy" alt="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}" class="table-avatar" src="{{ CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and job.userAssignedUserThumb ? job.userAssignedUserThumb|s3URL("small") : CONFIG.ROOTURL ~ '/api/file/avatarGen.php?users_userid=' ~ job.userAssignedUserID }}">
                                                                            </a>
                                                                        </li>
                                                                    </ul>
                                                                {% endif %}
                                                            </td>
                                                            <td class="project-state">
                                                                {% if job.maintenanceJobs_priority %}
                                                                    {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                        <span class="badge badge-{{ type.class }}" value="{{ type.id }}" {% if job.maintenanceJobs_priority != type.id %} style="display: none;" {% endif %}>{{ type.text }}</span>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            </td>
                                                            <td class="project-state">
                                                                {% if job.maintenanceJobsStatuses_name %}
                                                                    <span class="badge badge-default">{{ job.maintenanceJobsStatuses_name }}</span>
                                                                {% else %}
                                                                    <span class="badge badge-default">Awaiting Sorting</span>
                                                                {% endif %}
                                                            </td>
                                                            <td >
                                                                {% if job.maintenanceJobs_flagAssets == 1 %}
                                                                    <i class="fas fa-flag"></i>
                                                                {% endif %}
                                                            </td>
                                                            <td >
                                                                {% if job.maintenanceJobs_blockAssets == 1 %}
                                                                    <i class="fas fa-ban"></i>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="tab-pane" style="padding: 0" id="maintenance-jobsCompleted">
                                                <table class="table table-striped projects">
                                                    <thead>
                                                    <tr>
                                                        <th style="width: 1%">
                                                            #
                                                        </th>
                                                        <th>
                                                            Title
                                                        </th>
                                                        <th style="width: 5%">
                                                            Creator
                                                        </th>
                                                        <th style="width: 5%">
                                                            Assigned
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Priority
                                                        </th>
                                                        <th style="width: 8%" class="text-center">
                                                            Status
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-flag"></i>
                                                        </th>
                                                        <th style="width: 1%" class="text-center">
                                                            <i class="fas fa-ban"></i>
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for job in assets[0].jobs %}
                                                        {% if job.maintenanceJobsStatuses_id == 2 %}
                                                            <tr>
                                                                <td>
                                                                    <a href="{{ CONFIG.ROOTURL }}/maintenance/job.php?id={{ job.maintenanceJobs_id }}">#{{ job.maintenanceJobs_id }}</a>
                                                                </td>
                                                                <td>
                                                                    <a>
                                                                        {{ job.maintenanceJobs_title }}
                                                                    </a>
                                                                    <br/>
                                                                    <small>
                                                                        Created {{job.maintenanceJobs_timestamp_added|date("d M Y h:i:sa")}}
                                                                    </small>
                                                                </td>
                                                                <td>
                                                                    <ul class="list-inline">
                                                                        <li class="list-inline-item">
                                                                            <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userCreatorUserID }}" title="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 ~ " (" ~ job.userCreatorUserEMail ~ ")" }}">
                                                                                <img loading="lazy" alt="{{job.userCreatorUserName1 ~ " " ~ job.userCreatorUserName2 }}" class="table-avatar" src="{{ CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and job.userCreatorUserThumb ? job.userCreatorUserThumb|s3URL("small") : CONFIG.ROOTURL ~ '/api/file/avatarGen.php?users_userid=' ~ job.userCreatorUserID }}">
                                                                            </a>
                                                                        </li>
                                                                    </ul>
                                                                </td>
                                                                <td>
                                                                    {% if job.userAssignedUserName1 != null %}
                                                                        <ul class="list-inline">
                                                                            <li class="list-inline-item">
                                                                                <a href="{{ CONFIG.ROOTURL }}/user.php?id={{ job.userAssignedUserID }}" title="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}">
                                                                                    <img loading="lazy" alt="{{job.userAssignedUserName1 ~ " " ~ job.userAssignedUserName2 }}" class="table-avatar" src="{{ CONFIG.FILES_ENABLED == "Enabled" and USERDATA.instance.instances_storageEnabled == 1 and job.userAssignedUserThumb ? job.userAssignedUserThumb|s3URL("small") : CONFIG.ROOTURL ~ '/api/file/avatarGen.php?users_userid=' ~ job.userAssignedUserID }}">
                                                                                </a>
                                                                            </li>
                                                                        </ul>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobs_priority %}
                                                                        {% for type in MAINTENANCEJOBPRIORITIES %}
                                                                            <span class="badge badge-{{ type.class }}" value="{{ type.id }}" {% if job.maintenanceJobs_priority != type.id %} style="display: none;" {% endif %}>{{ type.text }}</span>
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                </td>
                                                                <td class="project-state">
                                                                    {% if job.maintenanceJobsStatuses_name %}
                                                                        <span class="badge badge-default">{{ job.maintenanceJobsStatuses_name }}</span>
                                                                    {% else %}
                                                                        <span class="badge badge-default">Awaiting Sorting</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_flagAssets == 1 %}
                                                                        <i class="fas fa-flag"></i>
                                                                    {% endif %}
                                                                </td>
                                                                <td >
                                                                    {% if job.maintenanceJobs_blockAssets == 1 %}
                                                                        <i class="fas fa-ban"></i>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- /.tab-content -->
                                    </div><!-- /.card-body -->
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <!-- /.tab-content -->
                </div><!-- /.card-body -->
            </div>
        </div>
    </div>
    {% if "LOCATIONS:VIEW"|instancePermissions and "ASSETS:ASSET_BARCODES:VIEW"|instancePermissions and assets[0].barcodes[0] %}
    <div class="modal fade" id="setAssetLocationAssetModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Set Asset Location to another Asset</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Set this asset's location to another asset - for example if it is stored within a flight case or storage box</p>
                    <div class="input-group my-3">
                        <select class="form-control" multiple="multiple" id="setAssetLocationAssetModal-assets" placeholder="Enter asset tags here"></select>
                    </div>
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="setAssetLocationAssetModal-button">Set location</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}




        <script>
            $(document).ready(function () {
                $(".assetSelect2").select2({
                    theme: "bootstrap4",
                    width: '100%'
                });
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                $('.slick').slick({
                    dots: true,
                    arrows: false,
                    pauseOnHover: true,
                    draggable: false,
                    infinite: true,
                    slidesToShow: 1,
                    slidesToScroll: 1,
                    autoplay: true,
                    autoplaySpeed: 5000,
                    fade: true,
                    cssEase: 'linear'
                });
                {% if "ASSETS:ASSET_BARCODES:EDIT:ASSOCIATE_UNNASOCIATED_BARCODES_WITH_ASSETS"|instancePermissions and ASSET_INSTANCE.instances_id == USERDATA.instance.instances_id %}
                // Initialize Select2 for barcode type with custom template
                function formatBarcodeType(option) {
                    if (!option.id) {
                        return option.text;
                    }

                    // Define sample barcode images for different types
                    var barcodeImages = {
                        'EAN_8': 'https://barcode.tec-it.com/barcode.ashx?data=1234567&code=EAN8&translate-esc=on&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0',
                        'EAN_13': 'https://barcode.tec-it.com/barcode.ashx?data=123456789012&code=EAN13&translate-esc=on&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0',
                        'CODE_39': 'https://barcode.tec-it.com/barcode.ashx?data=CODE39&code=Code39&translate-esc=on&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0',
                        'CODE_93': 'https://barcode.tec-it.com/barcode.ashx?data=CODE93&code=Code93&translate-esc=on&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0',
                        'CODE_128': 'https://barcode.tec-it.com/barcode.ashx?data=CODE128&code=Code128&translate-esc=on&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0',
                        'UPC_A': 'https://barcode.tec-it.com/barcode.ashx?data=01234567890&code=UPCA&translate-esc=on&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0',
                        'UPC_E': 'https://barcode.tec-it.com/barcode.ashx?data=0123456&code=UPCE&translate-esc=on&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0',
                        'QR_CODE': 'https://barcode.tec-it.com/barcode.ashx?data=QR&code=QRCode&translate-esc=on&dpi=96&imagetype=Gif&rotation=0&color=%23000000&bgcolor=%23ffffff&qunit=Mm&quiet=0'
                    };

                    var imageUrl = barcodeImages[option.id];
                    var description = $(option.element).data('desc') || '';

                    var $option = $(
                        '<div style="display: flex; align-items: center; padding: 8px 0;">' +
                            '<img src="' + imageUrl + '" style="height: 35px; width: auto; margin-right: 12px; border: 1px solid #dee2e6; border-radius: 3px; padding: 4px; background: white;" />' +
                            '<div style="flex: 1;">' +
                                '<div style="font-weight: 500; color: #212529;">' + option.text + '</div>' +
                                (description ? '<div style="font-size: 0.875rem; color: #6c757d;">' + description + '</div>' : '') +
                            '</div>' +
                        '</div>'
                    );
                    return $option;
                }

                $("#barcodeType").select2({
                    theme: 'bootstrap4',
                    placeholder: 'Select barcode type...',
                    allowClear: false,
                    templateResult: formatBarcodeType,
                    templateSelection: function(option) {
                        if (!option.id) {
                            return option.text;
                        }
                        return option.text;
                    },
                    escapeMarkup: function(markup) {
                        return markup;
                    }
                });

                // Barcode validation function
                function validateBarcode(value, type) {
                    if (!value || !type) return { valid: false, message: "" };

                    var validations = {
                        'EAN_8': {
                            regex: /^\d{7,8}$/,
                            message: "EAN-8 requires 7-8 numeric digits",
                            hint: "Enter 7-8 numeric digits (e.g., 1234567)"
                        },
                        'EAN_13': {
                            regex: /^\d{12,13}$/,
                            message: "EAN-13 requires 12-13 numeric digits",
                            hint: "Enter 12-13 numeric digits (e.g., 123456789012)"
                        },
                        'CODE_39': {
                            regex: /^[A-Z0-9\-\.\ \$\/\+\%]+$/,
                            message: "CODE-39 allows uppercase letters, numbers, and special characters (- . $ / + % space)",
                            hint: "Uppercase letters, numbers, and - . $ / + % space allowed"
                        },
                        'CODE_93': {
                            regex: /^[A-Z0-9\-\.\ \$\/\+\%]+$/,
                            message: "CODE-93 allows uppercase letters, numbers, and special characters",
                            hint: "Uppercase letters, numbers, and special characters allowed"
                        },
                        'CODE_128': {
                            regex: /^[\x20-\x7E]+$/,
                            message: "CODE-128 allows all ASCII characters",
                            hint: "Any printable ASCII characters allowed"
                        },
                        'UPC_A': {
                            regex: /^\d{11,12}$/,
                            message: "UPC-A requires 11-12 numeric digits",
                            hint: "Enter 11-12 numeric digits (e.g., 01234567890)"
                        },
                        'UPC_E': {
                            regex: /^\d{6,8}$/,
                            message: "UPC-E requires 6-8 numeric digits",
                            hint: "Enter 6-8 numeric digits (e.g., 0123456)"
                        },
                        'QR_CODE': {
                            regex: /.+/,
                            message: "QR Code can contain any text",
                            hint: "Any text allowed (no restrictions)"
                        }
                    };

                    var validation = validations[type];
                    if (!validation) return { valid: true, message: "" };

                    var valid = validation.regex.test(value);
                    return {
                        valid: valid,
                        message: validation.message,
                        hint: validation.hint
                    };
                }

                // Update hint text when barcode type changes
                $("#barcodeType").on("change", function() {
                    var type = $(this).val();
                    var value = $("#barcodeValue").val().trim();

                    if (type) {
                        var validation = validateBarcode("dummy", type);
                        $("#barcodeValueHint").text(validation.hint).removeClass("text-danger").addClass("text-muted");

                        // Validate current value if exists
                        if (value) {
                            var result = validateBarcode(value, type);
                            if (!result.valid) {
                                $("#barcodeValue").addClass("is-invalid");
                                $("#barcodeValueHint").text(result.message).removeClass("text-muted").addClass("text-danger");
                            } else {
                                $("#barcodeValue").removeClass("is-invalid");
                                $("#barcodeValueHint").text(validation.hint).removeClass("text-danger").addClass("text-muted");
                            }
                        }
                    } else {
                        $("#barcodeValueHint").text("Enter the barcode number/text").removeClass("text-danger").addClass("text-muted");
                    }
                });

                // Real-time validation as user types
                $("#barcodeValue").on("input", function() {
                    var value = $(this).val().trim();
                    var type = $("#barcodeType").val();

                    if (value && type) {
                        var result = validateBarcode(value, type);
                        if (!result.valid) {
                            $(this).addClass("is-invalid");
                            $("#barcodeValueHint").text(result.message).removeClass("text-muted").addClass("text-danger");
                        } else {
                            $(this).removeClass("is-invalid");
                            var validation = validateBarcode("dummy", type);
                            $("#barcodeValueHint").text(validation.hint).removeClass("text-danger").addClass("text-muted");
                        }
                    } else {
                        $(this).removeClass("is-invalid");
                    }
                });

                // Open modal when button is clicked
                $("#manuallyAssignBarcodeButton").on("click", function () {
                    $("#manuallyAssignBarcodeModal").modal("show");
                });

                // Handle form submission
                $("#manuallyAssignBarcodeSubmit").on("click", function () {
                    // Get form values
                    var barcodeValue = $("#barcodeValue").val().trim();
                    var barcodeType = $("#barcodeType").val();

                    // Validate inputs
                    if (!barcodeValue) {
                        bootbox.alert("Please enter a barcode value.");
                        return;
                    }

                    if (!barcodeType) {
                        bootbox.alert("Please select a barcode type.");
                        return;
                    }

                    // Validate barcode format
                    var validation = validateBarcode(barcodeValue, barcodeType);
                    if (!validation.valid) {
                        bootbox.alert("Invalid barcode format: " + validation.message);
                        $("#barcodeValue").addClass("is-invalid");
                        $("#barcodeValueHint").text(validation.message).removeClass("text-muted").addClass("text-danger");
                        return;
                    }

                    // Prepare data for API call
                    const args = {
                        "id": "{{ assets[0].assets_id }}",
                        "text": barcodeValue,
                        "type": barcodeType
                    };

                    // Disable submit button to prevent double-submission
                    $("#manuallyAssignBarcodeSubmit").prop("disabled", true).text("Assigning...");

                    // Make API call
                    ajaxcall("assets/barcodes/assign.php", args, function (data) {
                        // Close modal
                        $("#manuallyAssignBarcodeModal").modal("hide");

                        // Show success message using SweetAlert2 Toast
                        Toast.fire({
                            icon: 'success',
                            title: 'Barcode assigned successfully'
                        });

                        // Reload page to show new barcode in the table
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    });
                });

                // Reset form when modal is closed
                $("#manuallyAssignBarcodeModal").on("hidden.bs.modal", function () {
                    $("#manuallyAssignBarcodeForm")[0].reset();
                    $("#barcodeType").val(null).trigger('change');
                    $("#barcodeValue").removeClass("is-invalid");
                    $("#barcodeValueHint").text("Enter the barcode number/text").removeClass("text-danger").addClass("text-muted");
                    $("#manuallyAssignBarcodeSubmit").prop("disabled", false).text("Assign Barcode");
                });
                {% endif %}
                {% if "ASSETS:DELETE"|instancePermissions %}
                $(".deleteAssetButton").click(function () {
                    var assetid = $(this).data("assetid");
                    bootbox.confirm({
                        message: "Are you sure you wish to delete this asset?",
                        buttons: {
                            confirm: {
                                label: 'Yes',
                                className: 'btn-danger'
                            },
                            cancel: {
                                label: 'No',
                                className: 'btn-success'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajaxcall("assets/delete.php", {"assets_id":assetid}, function (data) {
                                    window.location.href = "{{CONFIG.ROOTURL}}/";
                                });
                            }
                        }
                    });
                });
                {% endif %}
                {% if "ASSETS:ARCHIVE"|instancePermissions %}
                $(".archiveAssetButton").click(function () {
                    var assetid = $(this).data("assetid");
                    var date;
                    bootbox.prompt({
                        title: "When would you like the asset to be archived?",
                        inputType: 'date',
                        callback: function (result) {
                            if (result) {
                                date = result;
                                bootbox.prompt({
                                    title: "Why is this asset being archived?",
                                    inputType: 'select',
                                    inputOptions: [
                                        {
                                            text: 'Being Sold',
                                            value: 'sold',
                                        },
                                        {
                                            text: 'End of Life - being destroyed',
                                            value: 'destroyed',
                                        },
                                        {
                                            text: 'Missing/Lost',
                                            value: 'lost',
                                        },
                                        {
                                            text: 'Permanent Loan',
                                            value: 'loaned permanently',
                                        }
                                    ],
                                    callback: function (result) {
                                        if (result) {
                                            ajaxcall("assets/archive.php", {"assets_id":assetid, "date":date,"reason":result}, function (data) {
                                                location.reload();
                                            });
                                        }
                                    }
                                });
                            }
                        }
                    });
                });
                {% endif %}
                {% if "ASSETS:ASSET_BARCODES:DELETE"|instancePermissions %}
                $(".deleteBarcodeButton").click(function () {
                    var barcodeid = $(this).data("barcodeid");
                    bootbox.confirm({
                        message: "Are you sure you wish to delete this barcode? All scan history for this barcode will be lost",
                        buttons: {
                            confirm: {
                                label: 'Yes',
                                className: 'btn-danger'
                            },
                            cancel: {
                                label: 'No',
                                className: 'btn-success'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajaxcall("assets/barcodes/delete.php", {"barcodes_id":barcodeid}, function (data) {

                                    location.reload();
                                });
                            }
                        }
                    });
                });
                {% endif %}
                {% if "ASSETS:ASSET_TYPES:EDIT"|instancePermissions %}
                $("#addNewType-value").change(function() {
                    $("#addNewType-dayRate-guide").html("2% = {{ moneySymbol() }}" + ($(this).val()*0.02).toFixed(2));
                    $("#addNewType-weekRate-guide").html("6% = {{ moneySymbol() }}" + ($(this).val()*0.06).toFixed(2));
                });
                $('#saveSettingsButton').on('click', function() {
                    var formData = $("#addNewForm").serializeArray();
                    formData.push({"name": "manufacturers_id", "value":$('#manufacturer').val()}, {"name": "assetTypes_id", "value": "{{asset.assetTypes_id}}"});
                    console.log(formData);
                    ajaxcall("assets/editAssetType.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                $('#saveTypeDefinableFieldButton').on('click', function() {
                    var formData = $("#editDefinableFieldsType").serializeArray();
                    formData.push({"name": "assetTypes_id", "value": "{{asset.assetTypes_id}}"});
                    ajaxcall("assets/editAssetTypeDefinableFields.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                {% endif %}
                {% if "ASSETS:EDIT"|instancePermissions %}
                $('#saveAssetSettingsButton').on('click', function() {
                    var formData = $("#editAssetDetailsForm").serializeArray();
                    formData.push({"name": "assets_id", "value": "{{assets[0]['assets_id']}}"});
                    ajaxcall("assets/editAsset.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                $('#saveAssetDefinableFieldButton').on('click', function() {
                    var formData = $("#editAssetDefinableFieldsForm").serializeArray();
                    formData.push({"name": "assets_id", "value": "{{assets[0]['assets_id']}}"});
                    ajaxcall("assets/editAsset.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                {% if "ASSETS:EDIT:OVVERRIDES"|instancePermissions %}
                $('#editAssetDetailsOverridesButton').on('click', function() {
                    var formData = $("#editAssetDetailsOverridesForm").serializeArray();
                    formData.push({"name": "assets_id", "value": "{{assets[0]['assets_id']}}"});
                    ajaxcall("assets/editAsset.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                {% endif %}
                $("#assetTypeChange").select2({
                    tags: false,
                    multiple: false,
                    theme: "bootstrap4",
                    minimumInputLength: 1,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Search for asset types",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/assets/searchType.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        return {
                                            text: item.manufacturers_name + " - " + item.assetTypes_name,
                                            id: item.assetTypes_id
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                });
                $('#saveAssetTypeChangeButton').on('click', function() {
                    if ($("#assetTypeChange").val()) {
                        var formData = [
                            {
                                "name" : "assets_id",
                                "value" : "{{ assets[0]['assets_id'] }}"
                            },
                            {
                                "name" : "assetTypes_id",
                                "value" : $("#assetTypeChange").val()
                            },
                        ];
                        ajaxcall("assets/editAsset.php", {formData}, function (data) {
                            window.location.href = "{{ CONFIG.ROOTURL }}/asset.php?instance={{ASSET_INSTANCE.instances_id}}&id=" + $("#assetTypeChange").val();
                        }, false);
                    }
                });

                $("#assetLinkChange").select2({
                    tags: false,
                    multiple: false,
                    theme: "bootstrap4",
                    minimumInputLength: 1,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Search for assets",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/assets/searchAssets.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        if (item.assets_id != '{{ assets[0]['assets_id'] }}') {
                                            return {
                                                text: item['tag'] + " | " + item.assetTypes_name,
                                                id: item['assets_id']
                                            }
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                });
                $('#saveAssetLinkChangeButton').on('click', function() {
                    if ($("#assetLinkChange").val()) {
                        var formData = [
                            {
                                "name" : "assets_id",
                                "value" : "{{ assets[0]['assets_id'] }}"
                            },
                            {
                                "name" : "assets_linkedTo",
                                "value" : $("#assetLinkChange").val()
                            },
                        ];
                        ajaxcall("assets/editAsset.php", {formData}, function (data) {
                            location.reload();
                        }, false);
                    }
                });
                $('#removeAssetLinkChangeButton').on('click', function() {
                    var formData = [
                        {
                            "name" : "assets_id",
                            "value" : "{{ assets[0]['assets_id'] }}"
                        },
                        {
                            "name" : "assets_linkedTo",
                            "value" : ""
                        },
                    ];
                    ajaxcall("assets/editAsset.php", {formData}, function (data) {
                        location.reload();
                    }, false);
                });
                {% endif %}

                $("#assetGroups").select2({
                    tags: false,
                    multiple: true,
                    theme: "bootstrap4",
                    {% if "ASSETS:ASSET_GROUPS:EDIT:ASSETS_WITHIN_GROUP"|instancePermissions != true %}
                    disabled: true,
                    {% endif %}
                    minimumInputLength: 1,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Enter group name to search",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/groups/search.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        return {
                                            text: item.assetGroups_name,
                                            id: item.assetGroups_id
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                });
                {% if "ASSETS:ASSET_GROUPS:EDIT:ASSETS_WITHIN_GROUP"|instancePermissions %}
                $('#assetGroups').on('select2:select', function (e) {
                    var id =e.params.data.id;
                    ajaxcall("groups/addAsset.php", {
                        "assetGroups_id": id,
                        "assets_id": "{{ assets[0]['assets_id'] }}"
                    });
                });
                $('#assetGroups').on('select2:unselect', function (e) {
                    var id =e.params.data.id;
                    ajaxcall("groups/removeAsset.php", {
                        "assetGroups_id": id,
                        "assets_id": "{{ assets[0]['assets_id'] }}"
                    });
                });
                {% endif %}
                {% if "MAINTENANCE_JOBS:VIEW"|instancePermissions %}
                $("#tagUserInJob").select2({
                    tags: false,
                    multiple: true,
                    theme: "bootstrap4",
                    minimumInputLength: 1,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Enter name to search for users",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/maintenance/searchUser.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        return {
                                            text: item.users_name1 + " " + item.users_name2,
                                            id: item.users_userid
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                });
                $('#addNewJobButton').on('click', function() {
                    var formData = $("#addNewJobForm").serializeArray();
                    if ($("#maintenanceJobstitle").val().length > 0 && $("#maintenanceJobsfaultDescription").val().length > 0) {
                        formData.push({"name": "maintenanceJobs_assets", "value": "{{assets[0]['assets_id']}}"},{"name": "maintenanceJobs_user_tagged", "value": $("#tagUserInJob").val()},{"name": "maintenanceJobs_user_creator", "value": "{{ USERDATA.users_userid }}"});
                        ajaxcall("maintenance/newJob.php", {formData}, function (data) {
                            window.location.href = "{{ CONFIG.ROOTURL }}/maintenance/job.php?id=" + data.response['maintenanceJobs_id'];
                        }, false);
                    }
                });
                {% endif %}
                {% if "MAINTENANCE_JOBS:SCHEDULES:VIEW"|instancePermissions %}
                // Scheduled Maintenance Handlers
                const assetId = {{ assets[0].assets_id }};

                $('#addScheduleButton').on('click', function() {
                    $('#scheduleFormTitle').text('Add Scheduled Maintenance');
                    $('#schedule_id').val('');
                    $('#scheduleFormElement')[0].reset();
                    $('#schedule_enabled').prop('checked', true);
                    $('#schedule_blockWhenOverdue').prop('checked', true);
                    $('#schedule_autoCreateJob').prop('checked', true);
                    $('#scheduleForm').slideDown();
                });

                $('#cancelScheduleButton').on('click', function() {
                    $('#scheduleForm').slideUp();
                    $('#scheduleFormElement')[0].reset();
                });

                $('#scheduleFormElement').on('submit', function(e) {
                    e.preventDefault();

                    const scheduleId = $('#schedule_id').val();
                    const isEdit = scheduleId.length > 0;

                    const data = {
                        assets_id: assetId,
                        type: $('#schedule_type').val(),
                        nextDue: $('#schedule_nextDue').val(),
                        intervalMonths: $('#schedule_intervalMonths').val() || null,
                        enabled: $('#schedule_enabled').is(':checked') ? 1 : 0,
                        blockWhenOverdue: $('#schedule_blockWhenOverdue').is(':checked') ? 1 : 0,
                        autoCreateJob: $('#schedule_autoCreateJob').is(':checked') ? 1 : 0
                    };

                    if (isEdit) {
                        data.assetMaintenanceSchedules_id = scheduleId;
                    }

                    const endpoint = isEdit ? 'maintenance/schedules/updateNextDue.php' : 'maintenance/schedules/create.php';

                    ajaxcall(endpoint, data, function(result) {
                        if (result.result) {
                            bootbox.alert({
                                message: isEdit ? 'Schedule updated successfully!' : 'Schedule created successfully!',
                                callback: function() {
                                    location.reload();
                                }
                            });
                        }
                    });
                });

                $('.editScheduleButton').on('click', function() {
                    const schedule = JSON.parse($(this).attr('data-schedule'));

                    $('#scheduleFormTitle').text('Edit Scheduled Maintenance');
                    $('#schedule_id').val(schedule.assetMaintenanceSchedules_id);
                    $('#schedule_type').val(schedule.assetMaintenanceSchedules_type);
                    $('#schedule_nextDue').val(schedule.assetMaintenanceSchedules_nextDue.split(' ')[0]);
                    $('#schedule_intervalMonths').val(schedule.assetMaintenanceSchedules_intervalMonths || '');
                    $('#schedule_enabled').prop('checked', schedule.assetMaintenanceSchedules_enabled == 1);
                    $('#schedule_blockWhenOverdue').prop('checked', schedule.assetMaintenanceSchedules_blockWhenOverdue == 1);
                    $('#schedule_autoCreateJob').prop('checked', schedule.assetMaintenanceSchedules_autoCreateJob == 1);

                    $('#scheduleForm').slideDown();
                    $('html, body').animate({
                        scrollTop: $('#scheduleForm').offset().top - 100
                    }, 500);
                });

                $('.deleteScheduleButton').on('click', function() {
                    const scheduleId = $(this).data('id');
                    const row = $(this).closest('tr');

                    bootbox.confirm({
                        title: "Delete Schedule",
                        message: "Are you sure you want to delete this scheduled maintenance? This cannot be undone.",
                        buttons: {
                            confirm: {
                                label: 'Delete',
                                className: 'btn-danger'
                            },
                            cancel: {
                                label: 'Cancel',
                                className: 'btn-secondary'
                            }
                        },
                        callback: function(result) {
                            if (result) {
                                ajaxcall('maintenance/schedules/updateNextDue.php', {
                                    assetMaintenanceSchedules_id: scheduleId,
                                    deleted: 1
                                }, function(response) {
                                    if (response.result) {
                                        row.fadeOut(300, function() {
                                            $(this).remove();
                                            if ($('#schedulesTableBody tr').length === 0) {
                                                location.reload();
                                            }
                                        });
                                    }
                                });
                            }
                        }
                    });
                });
                {% endif %}
                {% if "ASSETS:TRANSFER"|instancePermissions %}
                $("#assetMigrateInstance").select2({
                    tags: false,
                    multiple: false,
                    theme: "bootstrap4",
                    minimumInputLength: 0,
                    width: '100%',
                    minimumResultsForSearch: 1,
                    placeholder: "Search for a Business",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/instances/list.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        if (item.permissions.includes("ASSETS:TRANSFER") && item.instances_id != "{{ USERDATA.instance.instances_id }}") {
                                            return {
                                                text: item.instances_name,
                                                id: item.instances_id
                                            }
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                })

                $("#assetMigrateInstance").on('select2:select', function () {
                    var id = $(this).select2('data')[0].id;
                    $('#assetMigrateAssetType').parent().show();
                    try {
                        // destroy select2 if already initialized
                        $('#assetMigrateAssetType').select2('destroy');
                    } catch (e) {} // ignore
                    $('#assetMigrateAssetType').empty();
                    $('#assetMigrateAssetType').select2({
                        tags: false,
                        multiple: false,
                        theme: "bootstrap4",
                        minimumInputLength: 0,
                        width: '100%',
                        minimumResultsForSearch: 1,
                        placeholder: "Search for an Asset Type",
                        ajax: {
                            url: "{{ CONFIG.ROOTURL }}/api/assets/searchType.php?other_instances_id=" + id,
                            dataType: "json",
                            type: "POST",
                            data: function (params) {
                                var queryParameters = {
                                    term: params.term
                                }
                                return queryParameters;
                            },
                            processResults: function (data) {
                                if (data && data.result && data.response) {
                                    const responseData = $.map(data.response, function (item) {
                                            return {
                                                text: item.manufacturers_name + " - " + item.assetTypes_name,
                                                id: item.assetTypes_id
                                            }
                                        });
                                    return {
                                        // add "Other" to the end of the list
                                        results: [...responseData, {
                                            text: "Copy the existing asset type ({{asset.assetTypes_name|escape("js")}}) into business",
                                            id: "-1"
                                        }]
                                    };
                                } else return {
                                    results: [{
                                            text: "Copy the existing asset type ({{asset.assetTypes_name|escape("js")}}) into business",
                                            id: "-1"
                                        }]
                                };
                            }
                        }
                    })
                });
                $("#assetMigrateAssetType").on('select2:select', function () {
                    const id = $(this).select2('data')[0].id;
                    const instanceId = $("#assetMigrateInstance").select2('data')[0].id;
                    //Reset selectboxes
                    try {
                        // destroy select2 if already initialized
                        $('#assetMigrateManufacturer, #assetMigrateCategory').select2('destroy');
                    } catch (e) {} // ignore
                    $('#assetMigrateManufacturer, #assetMigrateCategory').empty();

                    if (id == "-1") {
                        $('#assetMigrateManufacturer').parent().show();
                        $('#assetMigrateCategory').parent().show();
                        $('#assetMigrateManufacturer').select2({
                            tags: false,
                            multiple: false,
                            theme: "bootstrap4",
                            minimumInputLength: 0,
                            width: '100%',
                            minimumResultsForSearch: 1,
                            placeholder: "Search for a Manufacturer",
                            ajax: {
                                url: "{{ CONFIG.ROOTURL }}/api/manufacturer/search.php?other_instances_id=" + instanceId,
                                dataType: "json",
                                type: "POST",
                                data: function (params) {
                                    var queryParameters = {
                                        term: params.term
                                    }
                                    return queryParameters;
                                },
                                processResults: function (data) {
                                    if (data && data.result && data.response) {
                                        const responseData = $.map(data.response, function (item) {
                                                return {
                                                    text: item.manufacturers_name,
                                                    id: item.manufacturers_id
                                                }
                                            })
                                        return {
                                        // add "Other" to the end of the list
                                        results: [...responseData,{
                                            text: "Copy {{ asset.manufacturers_name|escape("js") }} into business",
                                            id: "-1"
                                        }]
                                    };
                                    } else return {
                                        results: [{
                                            text: "Copy {{ asset.manufacturers_name|escape("js") }} into business",
                                            id: "-1"
                                        }]
                                    };
                                }
                            }
                        });
                        $('#assetMigrateCategory').select2({
                            tags: false,
                            multiple: false,
                            theme: "bootstrap4",
                            minimumInputLength: 0,
                            width: '100%',
                            minimumResultsForSearch: 1,
                            placeholder: "Search for a Category",
                            ajax: {
                                url: "{{ CONFIG.ROOTURL }}/api/categories/search.php?other_instances_id=" + instanceId,
                                dataType: "json",
                                type: "POST",
                                data: function (params) {
                                    var queryParameters = {
                                        term: params.term
                                    }
                                    return queryParameters;
                                },
                                processResults: function (data) {
                                    if (data && data.result && data.response) {
                                        return {
                                            results: $.map(data.response, function (item) {
                                                return {
                                                    text: item.assetCategoriesGroups_name + " - " + item.assetCategories_name,
                                                    id: item.assetCategories_id
                                                }
                                            })
                                        };
                                    } else return {
                                        results: []
                                    };
                                }
                            }
                        })
                    } else {
                        $('#assetMigrateManufacturer').parent().hide();
                        $('#assetMigrateCategory').parent().hide();
                    }
                });

                $("#assetMigrate").on("click", function () {
                    const newInstanceId = $("#assetMigrateInstance").select2('data')[0].id;
                    const newAssetTypeId = $("#assetMigrateAssetType").select2('data')[0].id;

                    const assetId = {{ assets[0]['assets_id'] }};
                    
                    let args = {}
                    if (newAssetTypeId == "-1") {
                        let newManufacturerId = -1;
                        newCategoryId = $("#assetMigrateCategory").select2('data')[0].id;
                        try {
                            newManufacturerId = $("#assetMigrateManufacturer").select2('data')[0].id;  
                        } catch (e) { } //ignore
                        args = {
                            "assets_id": assetId,
                            "new_instances_id": newInstanceId,
                            "manufacturers_id": (newManufacturerId == -1 ? false : newManufacturerId), //can be "Copied from Asset"
                            "assetCategories_id": newCategoryId,
                        }
                    } else {
                        args = {
                            "assets_id": assetId,
                            "new_instances_id": newInstanceId,
                            "assetTypes_id": newAssetTypeId,
                        }
                    }
                    bootbox.confirm({
                        message: "Are you sure you wish to transfer this asset?",
                        buttons: {
                            confirm: {
                                label: 'Yes',
                                className: 'btn-danger'
                            },
                            cancel: {
                                label: 'No',
                                className: 'btn-success'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajaxcall("assets/transfer.php", 
                                    args,
                                    function (data) {
                                        location.href = "{{ CONFIG.ROOTURL }}/assets.php";
                                    }
                                );
                            }
                        }
                    });
                });
                {% endif %}
                {% if "LOCATIONS:VIEW"|instancePermissions and assets[0].barcodes[0] %}
                $("#setAssetLocationButton").on("click", function () {
                    bootbox.prompt({
                        title: "Set Asset Location",
                        inputType: "select",
                        inputOptions: [
                        {% for location in locations %}
                            {
                                text: '{{ location.locations_name }}',
                                value: '{{ location.locations_name }}'
                            },
                        {% endfor %}
                        ],
                        callback: function (result) {
                            if(result ){
                                const args = {
                                    "text": "{{ assets[0]['barcodes'][0]['assetsBarcodes_value'] }}",
                                    "type": "{{ assets[0]['barcodes'][0]['assetsBarcodes_type'] }}",
                                    "locationType": "Custom",
                                    "location": result,
                                    "scanned": false,
                                    "validation": "Location selected from list"
                                }
                                ajaxcall('assets/barcodes/search.php', args, () => {location.reload()});
                            }
                        },
                    })
                });
                $("#setCustomLocationButton").on("click", function () {
                    bootbox.prompt({
                        title: "Set Custom Location for Asset",
                        callback: function (result) {
                            if(result ){
                                const args = {
                                    "text": "{{ assets[0]['barcodes'][0]['assetsBarcodes_value'] }}",
                                    "type": "{{ assets[0]['barcodes'][0]['assetsBarcodes_type'] }}",
                                    "locationType": "Custom",
                                    "location": result,
                                    "scanned": false,
                                    "validation": "Location manually entered"
                                }
                                ajaxcall('assets/barcodes/search.php', args, () => {location.reload()});
                            }
                        },
                    })
                })
                $("#setAssetLocationAssetButton").on("click", function () {
                    $('#setAssetLocationAssetModal').modal('show');
                });
                $("#setAssetLocationAssetModal-assets").select2({
                    tags: false,
                    multiple: false,
                    theme: "bootstrap4",
                    minimumInputLength: 1,
                    width: '100%',

                    minimumResultsForSearch: 1,
                    placeholder: "Enter asset numbers to search for assets",
                    ajax: {
                        url: "{{ CONFIG.ROOTURL }}/api/assets/searchAssets.php",
                        dataType: "json",
                        type: "POST",
                        data: function (params) {
                            var queryParameters = {
                                term: params.term,
                            }
                            return queryParameters;
                        },
                        processResults: function (data) {
                            if (data && data.result && data.response) {
                                return {
                                    results: $.map(data.response, function (item) {
                                        return {
                                            text: aTag(item.assets_tag) + " | " + item.assetTypes_name + " (" + item.manufacturers_name + ")",
                                            id: item.assets_id
                                        }
                                    })
                                };
                            } else return {
                                results: []
                            };
                        }
                    }
                });
                $("#setAssetLocationAssetModal-button").on("click", function() {
                    const args = {
                        "text": "{{ assets[0]['barcodes'][0]['assetsBarcodes_value'] }}",
                        "type": "{{ assets[0]['barcodes'][0]['assetsBarcodes_type'] }}",
                        "locationType": "asset",
                        "location": $("#setAssetLocationAssetModal-assets").val(),
                        "scanned": false,
                        "validation": "Asset selected from list"
                    }
                    ajaxcall('assets/barcodes/search.php', args, () => {location.reload()});
                });
                {% endif %} 
                {% if "LOCATIONS:VIEW"|instancePermissions %}
                $('#editAssetStoredLocation').select2({
                    tags: false,
                    multiple: false,
                    theme: "bootstrap4",
                    minimumInputLength: 0,
                    minimumResultsForSearch: 1,
                    templateResult: function (input) {
                        if (!input.id || !input.title) {
                            return input.text;
                        }
                        var $result = $(
                            '<span><b>' + input.title + ' </b>' + input.text + '</span>'
                        );
                        return $result;
                    }
                });
                {% endif %}
            });
        </script>

{% if "ASSETS:LABEL_PRINTERS:PRINT"|instancePermissions %}
<!-- Print Label Modal -->
<div class="modal fade" id="printLabelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Print Label for {{ assets[0].assets_tag }}</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Printer</label>
                    <select class="form-control" id="printPrinterSelect">
                        <option value="">-- Select Printer --</option>
                        {% for printer in labelPrinters %}
                        <option value="{{ printer.labelPrinters_id }}">
                            {{ printer.labelPrinters_name }} ({{ printer.labelPrinters_model }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Template</label>
                    <select class="form-control" id="printTemplateSelect">
                        <option value="">-- Select Template --</option>
                        {% for template in labelTemplates %}
                        <option value="{{ template.labelTemplates_id }}">
                            {{ template.labelTemplates_name }}
                            ({{ template.labelTemplates_width }}mm{% if template.labelTemplates_height > 0 %}  {{ template.labelTemplates_height }}mm{% endif %})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmPrintBtn">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    $("#printLabelBtn").click(function() {
        $("#printLabelModal").modal('show');
    });

    $("#confirmPrintBtn").click(function() {
        let printerId = $("#printPrinterSelect").val();
        let templateId = $("#printTemplateSelect").val();

        if (!printerId || !templateId) {
            alert('Please select both a printer and template');
            return;
        }

        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Printing...');

        $.post("{{ CONFIG.ROOTURL }}/api/labelPrinters/print.php", {
            labelPrinters_id: printerId,
            labelTemplates_id: templateId,
            assets_ids: [{{ assets[0].assets_id }}]
        }, function(data) {
            $("#confirmPrintBtn").prop('disabled', false).html('<i class="fas fa-print"></i> Print');

            if (data.result) {
                $("#printLabelModal").modal('hide');
                displayResponse(true, 'Label sent to printer successfully');
            } else {
                displayResponse(false, 'Print failed: ' + (data.error ? data.error.message : 'Unknown error'));
            }
        }).fail(function() {
            $("#confirmPrintBtn").prop('disabled', false).html('<i class="fas fa-print"></i> Print');
            displayResponse(false, 'Network error - failed to send print job');
        });
    });
});
</script>
{% endif %}

{% embed 'assets/templates/fileBoxJS.twig' %}

        {% endembed %}
{% endblock %}